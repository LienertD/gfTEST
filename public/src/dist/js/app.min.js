(function () {
    "use strict";

    var app = angular.module("geofeelings", ["ngRoute"]);

    app.config(function ($routeProvider) {
        $routeProvider
            .when("/admin", {
                templateUrl: "./controllers/adminController/admin.html"
            }).when("/search", {
                templateUrl: "./controllers/searchController/search.html"
            }).when("/intro", {
                templateUrl: "./controllers/introController/intro.html"
            }).when("/help", {
                templateUrl: "./directives/help.html"
            }).when("/login", {
                templateUrl: "./controllers/loginController/login.html"
            }).when("/register", {
                templateUrl: "./controllers/loginController/register.html"
            }).when("/user", {
                templateUrl: "./controllers/userController/user.html"
            }).when("/user/:param", {
                templateUrl: "./controllers/userController/user.html",
                controller: 'userController'
            }).when("/me", {
                templateUrl: "./controllers/userController/me.html"
            }).when("/event", {
                templateUrl: "./controllers/eventController/event.html"
            }).when("/event/:param", {
                templateUrl: "./controllers/eventController/event.html",
            }).when("/addEvent", {
                templateUrl: "./controllers/eventController/addEvent.html"
            }).when("/intro_shared", {
                templateUrl: "./controllers/introController/intro_shared.html"
            }).otherwise({
                redirectTo: "/intro"
            });
    });

    app.service('sharedProperties', function () {
        var property = 'First';

        return {
            getProperty: function () {
                return property;
            },
            setProperty: function (value) {
                property = value;
            }
        };
    });

})();

/**
 * Created by Jonatan on 6/12/2015.
 */

(function () {
    "use strict";

    var adminController = function ($scope, $location, eventService, shareService, profileService) {
        profileService.getUser(function (err, user) {
            if(!err) {
                if(user.redirect) {
                    $location.path(user.redirect);
                } else {
                    if(user.admin) {
                        eventService.getEvents(function (err, data) {
                            if(!err) {
                                if(data.redirect) {
                                    $location.path(data.redirect);
                                } else {
                                    $scope.eventsAdmin = data;
                                }
                            }
                            else {
                                throw new EventServiceException(err);
                            }
                        });

                        shareService.getAllShares(function (err, data) {
                            if(!err) {
                                if(data.redirect) {
                                    $location.path(data.redirect);
                                } else {
                                    $scope.sharesAdmin = data;
                                }
                            } else {
                                throw new ShareServiceException(err);
                            }
                        });
                    } else {
                        $location.path("/intro");
                    }
                }
            } else {
                throw new ProfileServiceException(err);
            }
        });

        $scope.deleteEvent = function (event) {
            eventService.deleteEvent(event, function(err, data) {
                if(!err) {
                    $scope.eventsAdmin.splice($scope.eventsAdmin.indexOf(event), 1);
                    window.alert(data.message);
                } else {
                    throw new EventServiceException(err);
                }
            });
        };

        $scope.deleteShare = function (share) {
            shareService.deleteShare(share, function(err, data) {
                if(!err) {
                    $scope.sharesAdmin.splice($scope.sharesAdmin.indexOf(share), 1);
                    window.alert(data.message);
                } else {
                    throw new ShareServiceException(err);
                }
            });
        };
    };

    angular.module("geofeelings").controller("adminController", ["$scope", "$location", "eventService", "shareService", "profileService", adminController]);
})();
/**
 * Created by Jonatan on 30/12/2015.
 */

(function () {
    "use strict";

    var addEventController = function ($scope, $location, eventService, profileService) {
        $scope.newEvent = {};
        $scope.errorAddEvent = null;

        profileService.getUser(function(err, user) {
            if(!err) {
                if(user.redirect) {
                    $location.path(user.redirect);
                } else {
                    $scope.newEvent.authorid = user.id;
                }
            } else {
                throw new ProfileServiceException(err);
            }
        });

        $scope.createEvent = function() {
            $scope.newEvent.address = makeAddress($scope.newEvent.address1, $scope.newEvent.address2);
            eventService.postEvent($scope.newEvent, function (err, data) {
                if(!err) {
                    if(data.redirect) {
                        $location.path(data.redirect);
                    } else if(data.error) {
                        $scope.errorAddEvent = data.error;
                    } else {
                        $location.path("/event/" + data.event._id);
                    }
                } else {
                    if(err === "ZERO_RESULTS") {
                        $scope.errorAddEvent = "No address found! Street & Number and Zip & City are required! Make sure ther is a space between your input and no ,";
                    } else {
                        $scope.errorAddEvent = "Something went wrong, try again later!";
                    }
                }
            });
        };

        var makeAddress = function (address1, address2) {
            return address1 + "," + address2;
        };
    };

    angular.module("geofeelings").controller("addEventController", ["$scope", "$location", "eventService", "profileService", addEventController]);
})();
/**
 * Created by Jonatan on 4/12/2015.
 */


(function () {
    "use strict";

    var eventController = function ($scope, $location, $sce, $routeParams, eventService, shareService, profileService) {
        var eventid = $routeParams.param;
        $scope.newEvent = {};

        eventService.getEventById(eventid, function(err, event) {
            if(!err) {
                $scope.event = event;
                $scope.event.mood = 50;
                $scope.event.eventid = event.id;
                $scope.event.address1 = splitAddress($scope.event.address, 0);
                $scope.event.address2 = splitAddress($scope.event.address, 1);

                if(!$scope.event.eventimage) {
                    $scope.event.eventimage = "http://student.howest.be/jonatan.michiels/geofeelings/assets/event.png";
                }

                if($scope.event.authorid) {
                    profileService.getUser(function(err, user) {
                        if(!err) {
                            $scope.event.userid = user.id;

                            if(user.redirect) {
                                $location.path(user.redirect);
                            } else {
                                return $scope.event.authorid === user.id;
                            }
                        } else {
                            throw new ProfileServiceException(err);
                        }
                    });
                } else {
                    $scope.event.isAuthor = false;
                }

                shareService.getSharesByEventId(event.id, function(err, shares) {
                    if(!err) {
                        if(shares.redirect) {
                            $location.path(shares.redirect);
                        } else {
                            if(shares.length > 0) {
                                $scope.sharesforevent = shares;
                            } else {
                                $scope.noSharesForEvent = "<div>No shares for this event.</div>";
                            }
                        }
                    } else {
                        throw new ShareServiceException(err);
                    }
                });
            } else {
                throw new EventServiceException(err);
            }
        });

        $scope.renderHtml = function(html) {
            return $sce.trustAsHtml(html);
        };

        $scope.postShare = function() {
            $scope.event.time = new Date();
            shareService.postShareAsync($scope.event, function(err, data) {
                if(!err) {
                    if(data.redirect) {
                        $location.path(data.redirect);
                    } else if(data.error) {
                        $scope.error = data.error;
                    } else {
                        $scope.event = data;
                    }
                } else {
                    if(err === "ZERO_RESULTS") {
                        $scope.error = "No address found!";
                    } else {
                        $scope.error = "Something went wrong, try again later!";
                    }
                }
            });
        };

        $scope.updateEvent = function() {
            $scope.event.address = makeAddress($scope.event.address1, $scope.event.address2);
            eventService.updateEvent($scope.event, function(err, data) {
                if(!err) {
                    if(data.redirect) {
                        $location.path(data.redirect);
                    } else if(data.error) {
                        $scope.errorEvent = data.error;
                    } else {
                        $scope.event = data;
                        $scope.event.address1 = splitAddress($scope.event.address, 0);
                        $scope.event.address2 = splitAddress($scope.event.address, 1);
                    }
                } else {
                    if(err === "ZERO_RESULTS") {
                        $scope.errorEvent = "No address found! Street & Number and Zip & City are required! Make sure ther is a space between your input and no komma(,)";
                    } else {
                        $scope.errorEvent = "Something went wrong, try again later!";
                    }
                }
            });
        };

        $scope.convertMood = function(mood) {
            if(mood > 80) {
                return "excited";
            } else if(mood > 60) {
                return "happy";
            } else if(mood > 40) {
                return "common";
            } else if (mood > 20) {
                return "sad";
            } else {
                return "depressive";
            }
        };

        var splitAddress = function (address, part) {
            var split = address.split(",");
            return split[part];
        };

        var makeAddress = function (address1, address2) {
            return address1 + "," + address2;
        };
    };

    angular.module("geofeelings").controller("eventController", ["$scope", "$location", "$sce", "$routeParams", "eventService", "shareService", "profileService", eventController]);
})();
/**
 * Created by Jonatan on 1/12/2015.
 */

(function () {
    "use strict";

    var introController = function ($scope, shareService, $http, $location, profileService, shareVarsBetweenCtrl, googleMapsService) {

        var socket = io.connect("http://localhost:3001");

        //SMILEY TEKENEN
        $scope.sliderValue = 50;
        $scope.moodWord = null;
        var c = document.getElementById("smileyCanvas");
        var ctx = c.getContext("2d");

        var sadRGB = [152, 30, 30];
        var happyRGB = [70, 161, 73];

        //telkens slidervalue verandert gezichtje tekenen
        $scope.$watch("sliderValue", function () {

            ctx.clearRect(0, 0, c.width, c.height); //canvas clearen voor nieuw frame

            var mood = $scope.sliderValue;
            giveMoodWord();
            //offset positie mond
            var offsetX = c.width / 5;
            var offSetY = c.width / 2.14 + (mood / (c.width / 6));

            //variabelen voor beziercurve (= mond)
            var SPx = offsetX;
            var SPy = offSetY + c.width / 3 - (mood * (c.width / 376.66));
            var H1x = offsetX;
            var H1y = offSetY + (mood * (c.width / 250));
            var H2x = offsetX + ((c.width / 300) * 180);
            var H2y = offSetY + (mood * (c.width / 250));
            var EPx = offsetX + (c.width / 1.666);
            var EPy = offSetY + (c.width / 3) - (mood * (c.width / 376.66));

            //hoofd
            ctx.lineWidth = c.width / 60;
            ctx.beginPath();
            ctx.arc((c.width / 2), (c.width / 2), (c.width / 2.07), 0, 2 * Math.PI);
            ctx.fillStyle = "rgb(" + moodColor(0) + "," + moodColor(1) + "," + moodColor(2) + ")";
            ctx.fill();
            ctx.strokeStyle = 'white';
            ctx.stroke();

            //mond

            ctx.lineWidth = c.width / 30;
            ctx.beginPath();
            ctx.moveTo(SPx, SPy);
            ctx.bezierCurveTo(H1x, H1y, H2x, H2y, EPx, EPy);
            //ctx.strokeStyle = 'black';
            ctx.stroke();
            ctx.lineCap = "round";

            //oog links

            ctx.lineWidth = c.width / 60;
            ctx.beginPath();
            ctx.arc(c.width / 3, c.width / 3, c.width / 15, 0, 2 * Math.PI);
            ctx.fillStyle = 'white';
            ctx.fill();
            ctx.stroke();

            //oog rechts
            ctx.beginPath();
            ctx.arc(c.width / 3 * 2, c.width / 3, c.width / 15, 0, 2 * Math.PI);
            ctx.fillStyle = 'white';
            ctx.fill();
            ctx.stroke();
        });

        var moodColor = function (c) {
            //c: R = 0, G = 1, B = 2

            if (sadRGB[c] > happyRGB[c]) {
                return Math.round(sadRGB[c] - ((sadRGB[c] - happyRGB[c]) * ($scope.sliderValue / 100)));
            }
            else {
                return Math.round(sadRGB[c] + ((happyRGB[c] - sadRGB[c]) * ($scope.sliderValue / 100)));
            }

        };

        var moodwords = ["horrible", "really bad", "bad", "okay", "good", "really good", "excellent"];

        var giveMoodWord = function () {
            if ($scope.sliderValue < 5) {
                $scope.moodWord = moodwords[0];
            }
            else if ($scope.sliderValue < 25) {
                $scope.moodWord = moodwords[1];
            }
            else if ($scope.sliderValue < 40) {
                $scope.moodWord = moodwords[2];
            }
            else if ($scope.sliderValue < 60) {
                $scope.moodWord = moodwords[3];
            }
            else if ($scope.sliderValue < 75) {
                $scope.moodWord = moodwords[4];
            }
            else if ($scope.sliderValue < 95) {
                $scope.moodWord = moodwords[5];
            }
            else {
                $scope.moodWord = moodwords[6];
            }
        };

        $http.get('/auth/user').success(function (data) {
            $scope.user = data;
        });
        $scope.sharePosted = false;

        $scope.postShare = function () {

            $scope.sharePosted = true; //zorgt ervoor dat spinnertje begint de draaien

            profileService.getUser(function (err, userData) {
                if (!err) {
                    if (userData.redirect) { //user is nog niet ingelogd bij het sharen
                        navigator.geolocation.getCurrentPosition(function (position) {
                            googleMapsService.convertCoordinatesToAdress(position.coords.latitude, position.coords.longitude, function (err, address) {
                                if (!err) {

                                    var shareAddress;
                                    if (err) {
                                        shareAddress = "";
                                    }
                                    else {
                                        shareAddress = address;
                                    }

                                    var userlessShareData = {
                                        "userid": 0,
                                        "eventid": null,
                                        "time": new Date().toISOString(),
                                        "mood": $scope.sliderValue,
                                        "lat": position.coords.latitude,
                                        "lng": position.coords.longitude,
                                        "address": shareAddress,
                                        "reason": $scope.moodReason
                                    };
                                    shareVarsBetweenCtrl.saveUserlessShare(userlessShareData);
                                }
                                else {
                                    console.log("erroke: " + err);
                                }
                            });
                        });
                        shareVarsBetweenCtrl.setExtraLoginInfo("Please login before posting this share.");
                        $location.path(userData.redirect);

                    } else {
                        navigator.geolocation.getCurrentPosition(function (position) {
                            googleMapsService.convertCoordinatesToAdress(position.coords.latitude, position.coords.longitude, function (err, address) {
                                var shareAddress;
                                if (err) {
                                    shareAddress = "";
                                }
                                else {
                                    shareAddress = address;
                                }

                                var shareData = {
                                    "userid": userData.id,
                                    "eventid": null,
                                    "time": new Date().toISOString(),
                                    "mood": $scope.sliderValue,
                                    "lat": position.coords.latitude,
                                    "lng": position.coords.longitude,
                                    "address": shareAddress,
                                    "reason": $scope.moodReason
                                };

                                shareService.postShareAsync(shareData, function (err, resShareData) {
                                    if (!err) {
                                        socket.emit("sharePosted", resShareData); //uitzenden naar iedereen
                                        shareVarsBetweenCtrl.setProperty(resShareData);
                                        $location.path("/intro_shared");
                                    }
                                    else {
                                        console.log(err);
                                    }
                                });

                            });
                        });
                    }
                } else {
                    console.log("error while getting user: " + err);
                }
            });
        };
    };

    angular.module("geofeelings").controller("introController", ["$scope", "shareService", "$http", "$location", "profileService", "shareVarsBetweenCtrl", "googleMapsService", introController]);
})();
/**
 * Created by Lienert on 21/12/2015.
 */

(function () {
    "use strict";

    var intro_sharedController = function ($scope, shareVarsBetweenCtrl) {
        $scope.infoPostedShare = shareVarsBetweenCtrl.getProperty();
    };
    angular.module("geofeelings").controller("intro_sharedController", ["$scope", "shareVarsBetweenCtrl", intro_sharedController]);
})();
/**
 * Created by Jonatan on 26/11/2015.
 */

(function () {
    "use strict";

    var socket = io.connect("http://localhost:3001");

    var loginController = function ($scope, $http, $location, shareVarsBetweenCtrl, shareService, profileService) {
        if (shareVarsBetweenCtrl.getExtraLoginInfo()) {
            $scope.extraLoginInfo = shareVarsBetweenCtrl.getExtraLoginInfo();
        }

        var postUserlessShare = function () {
            var shareData = shareVarsBetweenCtrl.returnUserlessShare();
            profileService.getUser(function (err, user) {
                if (!err) {
                    if (user.redirect) {
                        $location.path(user.redirect);
                    } else {
                        shareData.userid = user.id;

                        shareService.postShareAsync(shareData, function (err, resShareData) {
                            if (!err) {
                                shareVarsBetweenCtrl.setExtraLoginInfo("");
                                shareVarsBetweenCtrl.setProperty(resShareData);
                                $location.path("/intro_shared");
                            }
                            else {
                                console.log(err);
                            }
                        }); //post de share met de inlogdata dat hij nu weet
                        shareVarsBetweenCtrl.saveUserlessShare("");
                    }
                } else {
                    console.log("> error profileService: " + err);
                }
            });
        };

        //Moet nog naar een service omgezet worden
        $scope.login = function () {
            $http.post('http://localhost:3000/auth/login', {
                username: $scope.username,
                password: $scope.password
            }).success(function (data) {
                $scope.error = data.error;

                profileService.getUser(function (err, userData) { //zend je id naar de server om te zeggen dat je er bent en welk socketid je hebt
                    if (!err) {
                        if (userData.redirect) {
                            //userid niet logged in, nog toevoegen dat hij zen id stuurt bij inloggen!
                        } else {
                            console.log(userData);
                            socket.emit("loginMessage", userData.id);
                        }
                    } else {
                        console.log("error while getting userid: " + err);
                    }
                });

                if (shareVarsBetweenCtrl.returnUserlessShare() !== undefined && shareVarsBetweenCtrl.returnUserlessShare() !== "") //userid heeft willen sharen, maar was niet ingelogd.
                {
                    postUserlessShare();
                }
                else {
                    $location.path(data.redirect);
                }
            });
        };

        //Moet nog naar een service omgezet worden
        $scope.register = function () {
            $http.post('http://localhost:3000/auth/register', {
                username: $scope.username,
                password: $scope.password,
                email: $scope.email
            }).success(function (data) {
                $scope.error = data.error;
                if (shareVarsBetweenCtrl.returnUserlessShare() !== undefined && shareVarsBetweenCtrl.returnUserlessShare() !== "") //userid heeft willen sharen, maar was niet ingelogd.
                {
                    postUserlessShare();
                }
                else {
                    $location.path(data.redirect);
                }
            });
        };
    };

    angular.module("geofeelings").controller("loginController", ["$scope", "$http", "$location", "shareVarsBetweenCtrl", "shareService", "profileService", loginController]);
})();
/**
 * Created by Jonatan on 21/11/2015.
 */

(function () {
    "use strict";

    var mainController = function ($scope, googleMapsService, shareService, profileService, $location, $routeParams) {


        var socket = io.connect("http://localhost:3001");
        $scope.chatMessages = []; 


        $scope.init = function () {
            profileService.getUser(function (err, userData) { //zend je id naar de server om te zeggen dat je er bent en welk socketid je hebt
                if (!err) {
                    if (userData.redirect) {
                        //userid niet logged in, nog toevoegen dat hij zen id stuurt bij inloggen!
                    } else {
                        socket.emit("loginMessage", userData.id);
                    }
                } else {
                    console.log("error while getting user: " + err);
                }
            });
        };

        socket.on("sharePostedNotify", function (sharedata) {
            googleMapsService.showOnePostMarker(sharedata);
        });

        socket.on("chatMessage", function (data) { //ontvangen bericht
            $scope.chatMessages.push({text: data.text, sender: data.senderUsername, cssClass: "other"}); //pushen naar scope om chatbubble te tonen
            $scope.$apply(); //dit zorgt ervoor dat de chatbubbles er direct komen, niet verplaatsen!
        });

        $scope.sendChatMsgToServer = function () { //verzenden bericht
            var inputtext = document.getElementById("inputTextChat");
            if (inputtext.value !== "") {
                profileService.getUser(function (err, userData) {
                    if (!err) {
                        if (userData.redirect) { //user is nog niet ingelogd bij het chatten
                            shareVarsBetweenCtrl.setExtraLoginInfo("You need to be logged in to chat.");
                            $location.path(userData.redirect);
                        } else {

                            var messageObj = {
                                text: inputtext.value,
                                sender: userData.id,
                                receiver: $routeParams.param,
                                senderUsername: userData.username
                            };
                            socket.emit("chatMessage", messageObj);
                            $scope.chatMessages.push({
                                text: inputtext.value,
                                sender: userData.username,
                                cssClass: "me"
                            }); //pushen naar scope om chatbubble te tonen
                            inputtext.value = "";
                        }
                    } else {
                        console.log("error while getting user: " + err);
                    }
                });
            }
        };

        //chat einde

        shareService.getAllShares(function (err, shares) {
            if (!err) {
                googleMapsService.showLocationOnMap();
                $scope.shares = shares;
                $scope.timelapse = 0;
                $scope.timestamp = "last hour";
            } else {
                throw new ShareServiceException(err);
            }
        });

        $scope.$watch("timelapse", function() {
            if($scope.timelapse == 100) {
                $scope.timestamp = "All time";
                googleMapsService.removeMarkers();
                googleMapsService.showAllMarkers(filterSharesOnTime("all"));
            } else if($scope.timelapse == 80) {
                $scope.timestamp = "Last year";
                googleMapsService.removeMarkers();
                googleMapsService.showAllMarkers(filterSharesOnTime("year"));
            } else if($scope.timelapse == 60) {
                $scope.timestamp = "Last month";
                googleMapsService.removeMarkers();
                googleMapsService.showAllMarkers(filterSharesOnTime("month"));
            } else if($scope.timelapse == 40) {
                $scope.timestamp = "Last week";
                googleMapsService.removeMarkers();
                googleMapsService.showAllMarkers(filterSharesOnTime("week"));
            } else if($scope.timelapse == 20) {
                $scope.timestamp = "Last day";
                googleMapsService.removeMarkers();
                googleMapsService.showAllMarkers(filterSharesOnTime("day"));
            } else if($scope.timelapse === 0) {
                $scope.timestamp = "last hour";
                googleMapsService.removeMarkers();
                googleMapsService.showAllMarkers(filterSharesOnTime("hour"));
            }
        });

        var filterSharesOnTime = function(time) {
            var shares = [];

            switch (time) {
                case "all":
                    return $scope.shares;
                case "year":
                    angular.forEach($scope.shares, function(share) {
                        console.log(new Date().getYear() - new Date(share.time).getYear());
                        if((new Date().getTime() - new Date(share.time).getTime()) <= ((360000 * 24) * 365))
                            shares.push(share);
                    });
                    return shares;
                case "month":
                    angular.forEach($scope.shares, function(share) {
                        if((new Date().getTime() - new Date(share.time).getTime()) <= ((360000 * 24) * 31))
                            shares.push(share);
                    });
                    return shares;
                case "week":
                    angular.forEach($scope.shares, function(share) {
                        if((new Date().getTime() - new Date(share.time).getTime()) <= ((360000 * 24) * 7))
                            shares.push(share);
                    });
                    return shares;
                case "day":
                    angular.forEach($scope.shares, function(share) {
                        if((new Date().getTime() - new Date(share.time).getTime()) <= (360000 * 24))
                            shares.push(share);
                    });
                    return shares;
                case "hour":
                    angular.forEach($scope.shares, function(share) {
                        if((new Date().getTime() - new Date(share.time).getTime()) <= 360000)
                            shares.push(share);
                    });
                    return shares;
            }
        };
    };
    angular.module("geofeelings").controller("mainController", ["$scope", "googleMapsService", "shareService", "profileService", "$location", "$routeParams", mainController]);
})();
/**
 * Created by Jonatan on 25/11/2015.
 */


(function () {
    "use strict";

    var searchController = function ($scope, userService, eventService,profileService,shareVarsBetweenCtrl,$location) {

        $scope.searchModel = null;

        $scope.searchOnSubmit = function (formObj) {
            if ($scope.searchModel.length > 0) {
                searchNow();
            }
        };
        $scope.searchOnKeyPress = function () {
            if ($scope.searchModel !== null) {
                searchNow();
            }
        };

        $scope.filterSearchResults = function (i) {
            if ($scope.searchModel === "") {
                return false;
            }

            if (i.title.toLowerCase().indexOf($scope.searchModel.toLocaleLowerCase()) >= 0) {
                return true;
            }
            if (i.subtitle !== undefined) {
                if (i.subtitle.toLowerCase().indexOf($scope.searchModel.toLocaleLowerCase()) >= 0) {
                    return true;
                }
            }

            return false;
        };

        var searchNow = function () {
            $scope.maxResExceeded = false;

            profileService.getUser(function (err, userData) {
                if (!err) {
                    if (userData.redirect) { //user is nog niet ingelogd bij het sharen
                        shareVarsBetweenCtrl.setExtraLoginInfo("You need to login before using the search funtion.");
                        $location.path(userData.redirect);

                    } else {
                        userService.getAllUsers(function (err, results) {
                            if (err) {
                                console.log("error:" + err);
                            }
                            else {
                                var visibleres = [];
                                var i = 0, max = 5;
                                angular.forEach(results, function (res) {
                                    if (i < max) {
                                        visibleres.push(res);
                                        i++;
                                    }
                                });
                                $scope.searchResultsUsers = visibleres;
                            }
                        });

                        eventService.getAllEvents(function (err, results) {
                            if (err) {
                                console.log("error:" + err);
                            }
                            else {
                                var visibleres = [];
                                var i = 0, max = 5;
                                angular.forEach(results, function (res) {
                                    if (i < max) {
                                        visibleres.push(res);
                                        i++;
                                    }
                                });
                                $scope.searchResultsEvents = visibleres;
                            }
                        });
                    }
                } else {
                    console.log("error while getting user: " + err);
                }
            });
        };
    };

    angular.module("geofeelings").controller("searchController", ["$scope", "userService", "eventService","profileService","shareVarsBetweenCtrl","$location", searchController]);
})();
/**
 * Created by Jonatan on 21/12/2015.
 */

(function () {
    "use strict";

    var socket = io.connect("http://localhost:3001");

    var meController = function ($scope, $http, $location, $sce, profileService, shareService) {
        profileService.getUser(function (err, user) {
            if (!err) {
                if (user.redirect) {
                    $location.path(user.redirect);
                } else {
                    $scope.user = user;
                    if(user.address) {
                        $scope.user.address1 = splitAddress(user.address, 0);
                        $scope.user.address2 = splitAddress(user.address, 1);
                    }

                    if(!user.age) {
                        $scope.user.age = new Date();
                    }

                    shareService.getSharesByUserId(user.id, function (err, shares) {
                        if(!err) {
                            if(shares.redirect) {
                                $location.path(shares.redirect);
                            } else {
                                if(shares.length > 0) {
                                    $scope.sharesforprofile = shares;
                                } else {
                                    $scope.noSharesForUser = "<div>You have no shares yet, go share one <a href='#/intro'>here</a></div>";
                                }
                            }
                        } else {
                            throw new ShareServiceException(err);
                        }
                    });
                }
            } else {
                throw new ProfileServiceException(err);
            }
        });

        $scope.save = function (user) {
            user.address = makeAddress(user.address1, user.address2);
            profileService.saveUser(user, function(err, data) {
                if(!err) {
                    if (data.redirect) {
                        $location.path(data.redirect);
                    } else if(data.error) {
                        $scope.errorMe = data.error;
                    } else {
                        $scope.user = data;
                        $scope.user.address1 = splitAddress(data.address, 0);
                        $scope.user.address2 = splitAddress(data.address, 1);
                    }
                } else {
                    if(err === "ZERO_RESULTS") {
                        $scope.errorMe = "No address found! Street & Number and Zip & City are required! Make sure ther is a space between your input and no komma(,)";
                    } else {
                        $scope.errorMe = "Something went wrong, try again later!";
                    }
                }
            });
        };

        $scope.logout = function () {


            profileService.getUser(function (err, userData) { //zend je id naar de server om te zeggen dat je weggaat en niet meer wilt chatten
                if (!err) {
                    if (userData.redirect) {
                        //userid niet logged in, nog toevoegen dat hij zen id stuurt bij inloggen!
                    } else {
                        socket.emit("logoutMessage", userData.id);
                    }
                } else {
                    console.log("error while getting userid: " + err);
                }
            });

            profileService.logout().then(function (data) {
                $location.path(data);
            });
        };

        $scope.renderHtml = function(html) {
            return $sce.trustAsHtml(html);
        };

        $scope.getShareInfo = function(share) {
            if(share.event) {
                return share.event.eventname;
            } else {
                return share.address;
            }
        };

        $scope.getShareImage = function(share) {
            if(share.event) {
                return share.event.eventimage;
            } else {
                return "http://student.howest.be/jonatan.michiels/geofeelings/assets/location.png";
            }
        };

        var splitAddress = function (address, part) {
            var split = address.split(",");
            return split[part];
        };

        var makeAddress = function (address1, address2) {
            return address1 + "," + address2;
        };
    };

    angular.module("geofeelings").controller("meController", ["$scope", "$http", "$location", "$sce", "profileService", "shareService", meController]);
})();
/**
 * Created by Jonatan on 1/12/2015.
 */

(function () {
    "use strict";

    var userController = function ($scope, $location, userService, shareService, $routeParams) {

        $scope.init = function () {
            var userid = $routeParams.param;
            userService.searchUserFromId(userid).then(userFoundWithId);

            shareService.getSharesByUserId(userid, function (err, shares) {
                if (!err) {
                    $scope.shareFoundWithUserId = shares;
                    console.log($scope.shareFoundWithUserId);
                    var feelingImages = ["depressed", "sad", "common", "happy", "excited"];
                    angular.forEach(shares, function (share) {
                        share.moodImageSource = "./assets/" + feelingImages[giveFeelingsImageArrayNumber(share)] + ".png";
                        $scope.marker = new google.maps.Marker({
                            position: {lat: share.lat, lng: share.lng},
                            map: $scope.map,
                            icon: share.moodImageSource
                        });
                    });
                } else {
                    console.log("> error in shareService: " + err);
                }
            });
        };

        var userFoundWithId = function (res) {
            $scope.userfoundwithid = res;

            if (res.lat !== undefined && res.lat !== undefined) {
                $scope.map.setCenter(new google.maps.LatLng(res.lat, res.lng));
                if ($scope.marker !== undefined) {
                    $scope.marker.setMap(null); //verwijdert alle markers eerst
                }
                $scope.marker = new google.maps.Marker({
                    position: {lat: res.lat, lng: res.lng},
                    map: $scope.map,
                    icon: $scope.image
                });
            }
        };

        var giveFeelingsImageArrayNumber = function (share) {
            if (share.mood > 80) {
                return 4;
            }
            else {
                return Math.round(share.mood / 20);
            }
        };
    };

    angular.module("geofeelings").controller("userController", ["$scope", "$location", "userService", "shareService", "$routeParams", userController]);
})
();
/**
 * Created by Jonatan on 28/12/2015.
 */

var eventService = function ($http, googleMapsService) {
    "use strict";

    //private

    //public
    return {

        getAllEvents: function (cb) {
            $http.get("/api/event").success(function (data) {
                if (data.redirect) {
                    cb(null, data);
                } else {

                    var eventsFound = [];
                    angular.forEach(data, function (searchR) {
                        var newSR = new SearchResult(searchR.eventname, searchR.address, searchR._id,"event");
                        eventsFound.push(newSR);
                    });
                    cb(null, eventsFound);
                }
            }).error(function (error) {
                cb(error, null);
            });
        },

        getEvents: function (cb) {
            $http.get("/api/event").success(function (data) {
                if(data.redirect) {
                    cb(null, data);
                } else {
                    var events = [];
                    angular.forEach(data, function(event) {
                        events.push(new GfEvent(event._id, event.eventname, event.eventimage, event.authorid, event.from, event.until, event.lat, event.lng, event.address));
                    });
                    cb(null, events);
                }
            }).error(function (error) {
                cb(error, null);
            });
        },

        getEventById: function (eventid, cb) {
            $http.get("/api/event/" + eventid).success(function (data) {
                if (data.redirect) {
                    cb(null, data);
                } else {
                    if (data.address) {
                        cb(null, new GfEvent(data._id, data.eventname, data.eventimage, data.authorid, new Date(data.from), new Date(data.until), data.lat, data.lng, data.address));
                    } else {
                        googleMapsService.convertCoordinatesToAdress(data.lat, data.lng, function (err, address) {
                            if (!err) {
                                cb(null, cb(null, new GfEvent(data._id, data.eventname, data.eventimage, data.authorid, new Date(data.from), new Date(data.until), data.lat, data.lng, address)));
                            } else {
                                cb(err, null);
                            }
                        });
                    }
                }
            }).error(function (error) {
                cb(error, null);
            });
        },

        getEventByIdForShare: function (eventid, cb) {
            $http.get("/api/event/" + eventid).success(function(data) {
                cb(null, new GfEvent(data._id, data.eventname, data.eventimage, null, null, null, null, null, null));
            }).error(function (error) {
                cb(error, null);
            });
        },

        postEvent: function (data, cb) {
            googleMapsService.convertAdressToCoordinates(data.address, function (err, coord) {
                if (!err) {
                    data.lat = coord.lat();
                    data.lng = coord.lng();

                    $http.post("/api/event", new GfEvent(data._id, data.eventname, data.eventimage, data.authorid, new Date(data.from), new Date(data.until), data.lat, data.lng, data.address)).success(function (response) {
                        cb(null, response);
                    }).error(function (error) {
                        cb(error, null);
                    });
                } else {
                    cb(err, null);
                }
            });
        },

        updateEvent: function (data, cb) {
            googleMapsService.convertAdressToCoordinates(data.address, function (err, coord) {
                if (!err) {
                    data.lat = coord.lat();
                    data.lng = coord.lng();

                    $http.put("/api/event/" + data.id, data).success(function (response) {
                        cb(null, new GfEvent(response._id, response.eventname, response.eventimage, response.authorid, new Date(response.from), new Date(response.until), response.lat, response.lng, response.address));
                    }).error(function (error) {
                        cb(error, null);
                    });
                } else {
                    cb(err, null);
                }
            });
        },

        deleteEvent: function (event, cb) {
            $http.delete("/api/event/" + event.id).success(function (data) {
                cb(null, data);
            }).error(function (error) {
                cb(error, null);
            });
        }
    };
};

angular.module("geofeelings").factory("eventService", ["$http", "googleMapsService", eventService]);
/**
 * Created by Jonatan on 22/12/2015.
 */

// https://developers.google.com/maps/documentation/geocoding/intro?csw=1#Geocoding
// Dit gebruiken om adressen te vertalen naar lat en lng of omgekeerd
// Waarom? => google maps werkt met lat en lng, wordt zo opgeslaan in de database

var googleMapsService = function () {
    "use strict";
    // private
    var mapoptions = {
        zoom: 10,
        mapTypeId: google.maps.MapTypeId.ROADMAP,
        disableDefaultUI: true
    };
    var geocoder = new google.maps.Geocoder();
    var map = new google.maps.Map(document.querySelector("#map"), mapoptions);
    var markers = [];

    var chooseIcon = function (mood) {
        var url = "http://student.howest.be/jonatan.michiels/geofeelings/assets/";
        if (mood <= 20) {
            return url += "depressed.png";
        } else if (mood > 20 && mood <= 40) {
            return url += "sad.png";
        } else if (mood > 40 && mood <= 60) {
            return url += "common.png";
        } else if (mood > 60 && mood <= 80) {
            return url += "happy.png";
        } else {
            return url += "excited.png";
        }
    };

    //public
    return {
        showLocationOnMap: function () {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    map.setCenter(new google.maps.LatLng(position.coords.latitude, position.coords.longitude));
                    var marker = new google.maps.Marker({
                        position: map.getCenter(),
                        map: map,
                        icon: "http://student.howest.be/jonatan.michiels/geofeelings/assets/location_now.png"
                    });
                    markers.push(marker);
                });
            } else {
                // Throw map exception
            }
        },

        removeMarkers: function () {
            for (var i = 0; i < markers.length; i++) {
                markers[i].setMap(null);
            }
        },

        showOnePostMarker: function (data) {
            console.log(data);
            var marker = new google.maps.Marker({
                position: new google.maps.LatLng(data.lat, data.lng),
                map: map,
                icon: chooseIcon(data.mood)
            });

            if (!data.reason) {
                data.reason = "Random post with no reason!";
            }

            if (!data.event) {
                data.event.eventname = "No event data";
            }

            var infoWindow = new google.maps.InfoWindow();
            var content = "<h4 class='infowindowstyle'> Share details </h4>" +
                "<p class='infowindowstyle'> Time: <span>" + new Date(data.time) +
                "<p class='infowindowstyle'> Mood: <span>" + data.mood + "%</span></p>" +
                "<p class='infowindowstyle'> Reason: <span>" + data.reason + "</span></p>" + "</span></p>" +
                "<p class='infowindowstyle'> User: <span>" + data.user.username + "</span></p>" +
                "<p class='infowindowstyle'> Address: <span>" + data.address + "</span></p>" +
                "<p class='infowindowstyle'> Event: <span>" + data.event.eventname + "</span></p>";

            google.maps.event.addListener(marker, "click", (function (marker, content, infoWindow) {
                return function () {
                    infoWindow.setContent(content);
                    infoWindow.open(map, marker);
                };
            })(marker, content, infoWindow));

        },

        showAllMarkers: function (data) {
            var marker, i;
            for (i = 0; i < data.length; i++) {
                marker = new google.maps.Marker({
                    position: new google.maps.LatLng(data[i].lat, data[i].lng),
                    map: map,
                    icon: chooseIcon(data[i].mood)
                });

                if (!data[i].reason) {
                    data[i].reason = "Random post with no reason!";
                }

                if (!data[i].event.eventname) {
                    data[i].event.eventname = "No event data";
                }

                var infoWindow = new google.maps.InfoWindow();
                var content = "<h4 class='infowindowstyle'> Share details </h4>" +
                    "<p class='infowindowstyle'> Time: <span>" + new Date(data[i].time) +
                    "<p class='infowindowstyle'> Mood: <span>" + data[i].mood + "%</span></p>" +
                    "<p class='infowindowstyle'> Reason: <span>" + data[i].reason + "</span></p>" + "</span></p>" +
                    "<p class='infowindowstyle'> User: <span>" + data[i].user.username + "</span></p>" +
                    "<p class='infowindowstyle'> Address: <span>" + data[i].address + "</span></p>" +
                    "<p class='infowindowstyle'> Event: <span>" + data[i].event.eventname + "</span></p>";

                markers.push(marker);
                google.maps.event.addListener(marker, "click", (function (marker, content, infoWindow) {
                    return function () {
                        infoWindow.setContent(content);
                        infoWindow.open(map, marker);
                    };
                })(marker, content, infoWindow));
            }
        },

        convertAdressToCoordinates: function (address, cb) {
            geocoder.geocode({address: address}, function (results, status) {
                if (status == google.maps.GeocoderStatus.OK) {
                    cb(null, results[0].geometry.location);
                } else {
                    cb(status, null);
                }
            });
        },

        convertCoordinatesToAdress: function (lat, lng, cb) {
            var location = new google.maps.LatLng(lat, lng);
            geocoder.geocode({latLng: location}, function (results, status) {
                if (status == google.maps.GeocoderStatus.OK) {
                    cb(null, results[0].formatted_address);
                } else if (status == google.maps.GeocoderStatus.OVER_QUERY_LIMIT) {
                    setTimeout(function () {
                        cb(null, results[0].formatted_address);
                    }, 200);
                } else {
                    cb(status, null);
                }
            });
        }
    };
};

angular.module("geofeelings").factory("googleMapsService", [googleMapsService]);
/**
 * Created by Jonatan on 27/12/2015.
 */

var profileService = function ($http, googleMapsService) {
    "use strict";
    // private

    //public
    return {
        getUser: function (cb) {
            $http.get("/auth/user").success(function (data) {
                if (data.redirect) {
                    cb(null, data);
                } else {
                    cb(null, new GfUser(data._id, data.username, data.email, data.userimage, new Date(data.age), data.lat, data.lng, data.address, data.chat, data.admin));
                }
            }).error(function (error) {
                cb(error, null);
            });
        },

        saveUser: function (user, cb) {
            googleMapsService.convertAdressToCoordinates(user.address, function (err, coord) {
                if (!err) {
                    user.lat = coord.lat();
                    user.lng = coord.lng();

                    $http.put("/api/user/" + user.id, user).success(function (data) {
                        if (data.redirect) {
                            cb(null, data);
                        } else {
                            cb(null, new GfUser(data._id, data.username, data.email, data.userimage, new Date(data.age), data.lat, data.lng, data.address, data.chat, data.admin));
                        }
                    }).error(function (error) {
                        cb(error, null);
                    });
                } else {
                    cb(err, null);
                }
            });
        },

        logout: function () {
            return $http.get("/auth/logout").then(function (data) {

                return data;
            });
        }
    };
};

angular.module("geofeelings").factory("profileService", ["$http", "googleMapsService", profileService]);
/**
 * Created by Lienert on 23/12/2015.
 */

/**
 * OPMERKING VOOR LIENERT!!!!
 * post share zal niet werken
 * implementeer googleService
 * voorbeeld kan je vinden in profileservice (put functie)
 * Groetjes Jonatan
 */


var shareService = function ($http, $q, $location, googleMapsService, eventService, userService, shareVarsBetweenCtrl) {
    "use strict";

    //private
    var makeAddress = function (address) {
        if (address) {
            var split = address.split(",");
            return split[0] + ", " + split[1];
        } else {
            return null;
        }
    };

    var postShare = function (data) {
        $http({
            url: 'http://localhost:3000/api/share',
            method: 'POST',
            data: data
        }).success(function (serverData) {
            shareVarsBetweenCtrl.setProperty(serverData); //data kunnen doorgeven aan intro_sharedController
            $location.path("intro_shared");
        });
    };

    //public
    return {
        postShare: postShare,

        postShareAsync: function (data, cb) {
            if (data.address) {
                $http.post("/api/share", data).success(function (response) {
                    if (response.redirect) {
                        cb(null, response);
                    } else {
                        cb(null, new GfShare(data._id, data.userid, data.eventid, data.time, data.mood, data.lat, data.lng, makeAddress(data.address), data.reason));
                    }
                }).error(function (error) {
                    cb(error, null);
                });
            } else {
                googleMapsService.convertCoordinatesToAdress(data.lat, data.lng, function (err, address) {
                    if (!err) {
                        $http.post("/api/share", data).success(function (response) {
                            if (response.redirect) {
                                cb(null, response);
                            } else {
                                cb(null, new GfShare(data._id, data.userid, data.eventid, data.time, data.mood, data.lat, data.lng, makeAddress(address), data.reason));
                            }
                        }).error(function (error) {
                            cb(error, null);
                        });
                    } else {
                        cb(err, null);
                    }
                });
            }
        },

        getSharesByUserId: function (userid, cb) {
            $http.get("/api/share/user/" + userid).success(function (data) {
                if (data.redirect) {
                    cb(null, data);
                } else {
                    var shares = [];

                    angular.forEach(data, function (share) {
                        userService.getUserByIdForShare(share.userid, function(err, user) {
                            if(!err) {
                                share.user = user;
                                eventService.getEventByIdForShare(share.eventid, function(err, event) {
                                    if(!err) {
                                        share.event = event;
                                        shares.push(new GfShareExtended(share._id, share.user, share.event, share.time, share.mood, share.lat, share.lng, makeAddress(share.address), share.reason));

                                        if(data.length === shares.length) {
                                            cb(null, shares);
                                        }
                                    }
                                });
                            }
                        });
                    });
                }
            }).error(function (error) {
                cb(error, null);
            });
        },

        getSharesByEventId: function (eventid, cb) {
            $http.get("/api/share/event/" + eventid).success(function (data) {
                if (data.redirect) {
                    cb(null, data);
                } else {
                    var shares = [];
                    angular.forEach(data, function (share) {
                        userService.getUserByIdForShare(share.userid, function(err, user) {
                            if(!err) {
                                share.user = user;
                                eventService.getEventByIdForShare(share.eventid, function(err, event) {
                                    if(!err) {
                                        share.event = event;
                                        shares.push(new GfShareExtended(share._id, share.user, share.event, share.time, share.mood, share.lat, share.lng, makeAddress(share.address), share.reason));

                                        if(data.length === shares.length) {
                                            cb(null, shares);
                                        }
                                    }
                                });
                            }
                        });
                    });
                }
            }).error(function (error) {
                cb(error, null);
            });
        },

        getAllShares: function (cb) {
            $http.get("/api/share").success(function (data) {
                var shares = [];
                angular.forEach(data, function (share) {
                    userService.getUserByIdForShare(share.userid, function(err, user) {
                        if(!err) {
                            share.user = user;
                            eventService.getEventByIdForShare(share.eventid, function(err, event) {
                                if(!err) {
                                    share.event = event;
                                    shares.push(new GfShareExtended(share._id, share.user, share.event, share.time, share.mood, share.lat, share.lng, makeAddress(share.address), share.reason));

                                    if(data.length === shares.length) {
                                        cb(null, shares);
                                    }
                                }
                            });
                        }
                    });
                });
            }).error(function (error) {
                cb(error, null);
            });
        },

        deleteShare: function (share, cb) {
            $http.delete("/api/share/" + share.id).success(function (data) {
                cb(null, data);
            }).error(function (error) {
                cb(error, null);
            });
        }
    };
};
angular.module("geofeelings").factory("shareService", ["$http", "$q", "$location", "googleMapsService", "eventService", "userService", "shareVarsBetweenCtrl", shareService]);

/**
 * Created by liene on 28/12/2015.
 */


var shareVarsBetweenCtrl = function () {
    "use strict";

    //private
    var property;
    var userlessShare;
    var ExtraLoginInfo;
    //public
    return {

        getProperty: function () {
            return property;
        },

        setProperty: function (value) {
            property = value;
        },

        setExtraLoginInfo: function (data) {
            ExtraLoginInfo = data;
        },
        getExtraLoginInfo: function () {
            return ExtraLoginInfo;
        },

        saveUserlessShare: function (data) {
            userlessShare = data;
        },
        returnUserlessShare: function () {
            return userlessShare;
        }
    };
};

angular.module("geofeelings").factory("shareVarsBetweenCtrl", [shareVarsBetweenCtrl]);
(function () {
    "use strict";

    var userService = function ($http) {

        var getAllUsers = function (cb) {
            $http.get("/api/user").success(function (data) {
                if (data.redirect) {
                    cb(null, data);
                } else {

                var arSearchResults = [];
                    angular.forEach(data, function (searchR) {
                        var newSR = new SearchResult(searchR.username, searchR.email, searchR._id,"user");
                        arSearchResults.push(newSR);
                    });
                    cb(null, arSearchResults);
                }
            }).error(function (error) {
                cb(error, null);
            });
        };


        var searchUserFromId = function (searchString) {
            var url = 'http://localhost:3000/api/user/' + searchString;
            return $http.get(url).then(function (response) {
                return new GfUser(
                    response.data._id,
                    response.data.username,
                    response.data.email,
                    response.data.userimage,
                    response.data.age,
                    response.data.lat,
                    response.data.lng,
                    response.data.address,
                    response.data.chat,
                    response.data.admin
                );

            });
        };

        return {
            getAllUsers: getAllUsers,
            searchUserFromId: searchUserFromId,
            getUserByIdForShare: function(userid, cb) {
                $http.get("/api/user/" + userid).success(function(data) {
                    cb(null, new GfUser(data._id, data.username, null, data.userimage, null, null, null, null, null, null));
                }).error(function (error) {
                    cb(error, null);
                });
            }
        };
    };
    angular.module("geofeelings").factory("userService", ["$http", userService]);
})();
/**
 * Created by Jonatan on 28/12/2015.
 */

function GfEvent(id, eventname, eventimage, authorid, from, until, lat, lng, address) {
    this.id = id;
    this.eventname = eventname;
    this.eventimage = eventimage;
    this.authorid = authorid;
    this.from = from;
    this.until = until;
    this.lat = lat;
    this.lng = lng;
    this.address = address;
}

GfShare.prototype.toString = function () {
    return this.eventname;
};
function GfShare(id, userid, eventid, time, mood, lat, lng, address, reason) {
    this.id = id;
    this.userid = userid;
    this.eventid = eventid;
    this.time = time;
    this.mood = mood;
    this.lat = lat;
    this.lng = lng;
    this.address = address;
    this.reason = reason;
}

GfShare.prototype.toString = function () {
    return this.userid + " (" + this.time + ")";
};

/**
 * Created by Jonatan on 31/12/2015.
 */

function GfShareExtended(id, user, event, time, mood, lat, lng, address, reason) {
    this.id = id;
    this.user = user;
    this.event = event;
    this.time = time;
    this.mood = mood;
    this.lat = lat;
    this.lng = lng;
    this.address = address;
    this.reason = reason;
}

GfShare.prototype.toString = function () {
    return this.userid + " (" + this.time + ")";
};
function GfUser(id, username, email, userimage, age, lat, lng, address, chat, admin) {
    this.id = id;
    this.username = username;
    this.email = email;
    this.userimage = userimage;
    this.age = age;
    this.lat = lat;
    this.lng = lng;
    this.address = address;
    this.chat = chat;
    this.admin = admin;
}

GfUser.prototype.toString = function () {
    return this.username;
};

function SearchResult(title, subtitle, id, resultSort) {
    this.title = title;
    this.subtitle = subtitle;
    this.id = id;
    this.resultSort = resultSort;
}
SearchResult.prototype.toString = function () {
    return this.title;
};

/**
 * Created by Jonatan on 31/12/2015.
 */

function EventServiceException(message) {
    this.name = "EventServiceException";
    this.message = message;
    this.stack = (new Error()).stack;
}

// IE9

EventServiceException.prototype = Object.create(Error.prototype);
EventServiceException.prototype.constructor = EventServiceException;
/**
 * Created by Jonatan on 31/12/2015.
 */

function ProfileServiceException(message) {
    this.name = "ProfileServiceException";
    this.message = message;
    this.stack = (new Error()).stack;
}

// IE9

ProfileServiceException.prototype = Object.create(Error.prototype);
ProfileServiceException.prototype.constructor = ProfileServiceException;
/**
 * Created by Jonatan on 31/12/2015.
 */

function ShareServiceException(message) {
    this.name = "ShareServiceException";
    this.message = message;
    this.stack = (new Error()).stack;
}

// IE9

ShareServiceException.prototype = Object.create(Error.prototype);
ShareServiceException.prototype.constructor = ShareServiceException;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC5qcyIsImFkbWluQ29udHJvbGxlci9hZG1pbkNvbnRyb2xsZXIuanMiLCJldmVudENvbnRyb2xsZXIvYWRkRXZlbnRDb250cm9sbGVyLmpzIiwiZXZlbnRDb250cm9sbGVyL2V2ZW50Q29udHJvbGxlci5qcyIsImludHJvQ29udHJvbGxlci9pbnRyb0NvbnRyb2xsZXIuanMiLCJpbnRyb0NvbnRyb2xsZXIvaW50cm9fc2hhcmVkQ29udHJvbGxlci5qcyIsImxvZ2luQ29udHJvbGxlci9sb2dpbkNvbnRyb2xsZXIuanMiLCJtYWluQ29udHJvbGxlci9tYWluQ29udHJvbGxlci5qcyIsInNlYXJjaENvbnRyb2xsZXIvc2VhcmNoQ29udHJvbGxlci5qcyIsInVzZXJDb250cm9sbGVyL21lQ29udHJvbGxlci5qcyIsInVzZXJDb250cm9sbGVyL3VzZXJDb250cm9sbGVyLmpzIiwiZXZlbnRTZXJ2aWNlLmpzIiwiZ29vZ2xlTWFwc1NlcnZpY2UuanMiLCJwcm9maWxlU2VydmljZS5qcyIsInNoYXJlU2VydmljZS5qcyIsInNoYXJlVmFyc0JldHdlZW5DdHJscy5qcyIsInVzZXJTZXJ2aWNlLmpzIiwiZ2ZFdmVudC5qcyIsImdmU2hhcmUuanMiLCJnZlNoYXJlRXh0ZW5kZWQuanMiLCJnZlVzZXIuanMiLCJTZWFyY2hSZXN1bHQuanMiLCJFdmVudFNlcnZpY2VFeGNlcHRpb24uanMiLCJQcm9maWxlU2VydmljZUV4Y2VwdGlvbi5qcyIsIlNoYXJlU2VydmljZUV4Y2VwdGlvbi5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNyREE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDdkVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ2xEQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3ZJQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUMzTUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDWEE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDNUZBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDdEpBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQzVGQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3hIQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQzVEQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3hIQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQzVKQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDcERBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDcktBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDdkNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3hEQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ2xCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ2ZBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDbEJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNoQkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNUQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDYkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ2JBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EiLCJmaWxlIjoiYXBwLm1pbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIihmdW5jdGlvbiAoKSB7XHJcbiAgICBcInVzZSBzdHJpY3RcIjtcclxuXHJcbiAgICB2YXIgYXBwID0gYW5ndWxhci5tb2R1bGUoXCJnZW9mZWVsaW5nc1wiLCBbXCJuZ1JvdXRlXCJdKTtcclxuXHJcbiAgICBhcHAuY29uZmlnKGZ1bmN0aW9uICgkcm91dGVQcm92aWRlcikge1xyXG4gICAgICAgICRyb3V0ZVByb3ZpZGVyXHJcbiAgICAgICAgICAgIC53aGVuKFwiL2FkbWluXCIsIHtcclxuICAgICAgICAgICAgICAgIHRlbXBsYXRlVXJsOiBcIi4vY29udHJvbGxlcnMvYWRtaW5Db250cm9sbGVyL2FkbWluLmh0bWxcIlxyXG4gICAgICAgICAgICB9KS53aGVuKFwiL3NlYXJjaFwiLCB7XHJcbiAgICAgICAgICAgICAgICB0ZW1wbGF0ZVVybDogXCIuL2NvbnRyb2xsZXJzL3NlYXJjaENvbnRyb2xsZXIvc2VhcmNoLmh0bWxcIlxyXG4gICAgICAgICAgICB9KS53aGVuKFwiL2ludHJvXCIsIHtcclxuICAgICAgICAgICAgICAgIHRlbXBsYXRlVXJsOiBcIi4vY29udHJvbGxlcnMvaW50cm9Db250cm9sbGVyL2ludHJvLmh0bWxcIlxyXG4gICAgICAgICAgICB9KS53aGVuKFwiL2hlbHBcIiwge1xyXG4gICAgICAgICAgICAgICAgdGVtcGxhdGVVcmw6IFwiLi9kaXJlY3RpdmVzL2hlbHAuaHRtbFwiXHJcbiAgICAgICAgICAgIH0pLndoZW4oXCIvbG9naW5cIiwge1xyXG4gICAgICAgICAgICAgICAgdGVtcGxhdGVVcmw6IFwiLi9jb250cm9sbGVycy9sb2dpbkNvbnRyb2xsZXIvbG9naW4uaHRtbFwiXHJcbiAgICAgICAgICAgIH0pLndoZW4oXCIvcmVnaXN0ZXJcIiwge1xyXG4gICAgICAgICAgICAgICAgdGVtcGxhdGVVcmw6IFwiLi9jb250cm9sbGVycy9sb2dpbkNvbnRyb2xsZXIvcmVnaXN0ZXIuaHRtbFwiXHJcbiAgICAgICAgICAgIH0pLndoZW4oXCIvdXNlclwiLCB7XHJcbiAgICAgICAgICAgICAgICB0ZW1wbGF0ZVVybDogXCIuL2NvbnRyb2xsZXJzL3VzZXJDb250cm9sbGVyL3VzZXIuaHRtbFwiXHJcbiAgICAgICAgICAgIH0pLndoZW4oXCIvdXNlci86cGFyYW1cIiwge1xyXG4gICAgICAgICAgICAgICAgdGVtcGxhdGVVcmw6IFwiLi9jb250cm9sbGVycy91c2VyQ29udHJvbGxlci91c2VyLmh0bWxcIixcclxuICAgICAgICAgICAgICAgIGNvbnRyb2xsZXI6ICd1c2VyQ29udHJvbGxlcidcclxuICAgICAgICAgICAgfSkud2hlbihcIi9tZVwiLCB7XHJcbiAgICAgICAgICAgICAgICB0ZW1wbGF0ZVVybDogXCIuL2NvbnRyb2xsZXJzL3VzZXJDb250cm9sbGVyL21lLmh0bWxcIlxyXG4gICAgICAgICAgICB9KS53aGVuKFwiL2V2ZW50XCIsIHtcclxuICAgICAgICAgICAgICAgIHRlbXBsYXRlVXJsOiBcIi4vY29udHJvbGxlcnMvZXZlbnRDb250cm9sbGVyL2V2ZW50Lmh0bWxcIlxyXG4gICAgICAgICAgICB9KS53aGVuKFwiL2V2ZW50LzpwYXJhbVwiLCB7XHJcbiAgICAgICAgICAgICAgICB0ZW1wbGF0ZVVybDogXCIuL2NvbnRyb2xsZXJzL2V2ZW50Q29udHJvbGxlci9ldmVudC5odG1sXCIsXHJcbiAgICAgICAgICAgIH0pLndoZW4oXCIvYWRkRXZlbnRcIiwge1xyXG4gICAgICAgICAgICAgICAgdGVtcGxhdGVVcmw6IFwiLi9jb250cm9sbGVycy9ldmVudENvbnRyb2xsZXIvYWRkRXZlbnQuaHRtbFwiXHJcbiAgICAgICAgICAgIH0pLndoZW4oXCIvaW50cm9fc2hhcmVkXCIsIHtcclxuICAgICAgICAgICAgICAgIHRlbXBsYXRlVXJsOiBcIi4vY29udHJvbGxlcnMvaW50cm9Db250cm9sbGVyL2ludHJvX3NoYXJlZC5odG1sXCJcclxuICAgICAgICAgICAgfSkub3RoZXJ3aXNlKHtcclxuICAgICAgICAgICAgICAgIHJlZGlyZWN0VG86IFwiL2ludHJvXCJcclxuICAgICAgICAgICAgfSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBhcHAuc2VydmljZSgnc2hhcmVkUHJvcGVydGllcycsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB2YXIgcHJvcGVydHkgPSAnRmlyc3QnO1xyXG5cclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICBnZXRQcm9wZXJ0eTogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHByb3BlcnR5O1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBzZXRQcm9wZXJ0eTogZnVuY3Rpb24gKHZhbHVlKSB7XHJcbiAgICAgICAgICAgICAgICBwcm9wZXJ0eSA9IHZhbHVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuICAgIH0pO1xyXG5cclxufSkoKTtcclxuIiwiLyoqXHJcbiAqIENyZWF0ZWQgYnkgSm9uYXRhbiBvbiA2LzEyLzIwMTUuXHJcbiAqL1xyXG5cclxuKGZ1bmN0aW9uICgpIHtcclxuICAgIFwidXNlIHN0cmljdFwiO1xyXG5cclxuICAgIHZhciBhZG1pbkNvbnRyb2xsZXIgPSBmdW5jdGlvbiAoJHNjb3BlLCAkbG9jYXRpb24sIGV2ZW50U2VydmljZSwgc2hhcmVTZXJ2aWNlLCBwcm9maWxlU2VydmljZSkge1xyXG4gICAgICAgIHByb2ZpbGVTZXJ2aWNlLmdldFVzZXIoZnVuY3Rpb24gKGVyciwgdXNlcikge1xyXG4gICAgICAgICAgICBpZighZXJyKSB7XHJcbiAgICAgICAgICAgICAgICBpZih1c2VyLnJlZGlyZWN0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgJGxvY2F0aW9uLnBhdGgodXNlci5yZWRpcmVjdCk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmKHVzZXIuYWRtaW4pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnRTZXJ2aWNlLmdldEV2ZW50cyhmdW5jdGlvbiAoZXJyLCBkYXRhKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZighZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoZGF0YS5yZWRpcmVjdCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkbG9jYXRpb24ucGF0aChkYXRhLnJlZGlyZWN0KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkc2NvcGUuZXZlbnRzQWRtaW4gPSBkYXRhO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFdmVudFNlcnZpY2VFeGNlcHRpb24oZXJyKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICBzaGFyZVNlcnZpY2UuZ2V0QWxsU2hhcmVzKGZ1bmN0aW9uIChlcnIsIGRhdGEpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKCFlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihkYXRhLnJlZGlyZWN0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRsb2NhdGlvbi5wYXRoKGRhdGEucmVkaXJlY3QpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZS5zaGFyZXNBZG1pbiA9IGRhdGE7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgU2hhcmVTZXJ2aWNlRXhjZXB0aW9uKGVycik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICRsb2NhdGlvbi5wYXRoKFwiL2ludHJvXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBQcm9maWxlU2VydmljZUV4Y2VwdGlvbihlcnIpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICRzY29wZS5kZWxldGVFdmVudCA9IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgICAgICAgICBldmVudFNlcnZpY2UuZGVsZXRlRXZlbnQoZXZlbnQsIGZ1bmN0aW9uKGVyciwgZGF0YSkge1xyXG4gICAgICAgICAgICAgICAgaWYoIWVycikge1xyXG4gICAgICAgICAgICAgICAgICAgICRzY29wZS5ldmVudHNBZG1pbi5zcGxpY2UoJHNjb3BlLmV2ZW50c0FkbWluLmluZGV4T2YoZXZlbnQpLCAxKTtcclxuICAgICAgICAgICAgICAgICAgICB3aW5kb3cuYWxlcnQoZGF0YS5tZXNzYWdlKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEV2ZW50U2VydmljZUV4Y2VwdGlvbihlcnIpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICAkc2NvcGUuZGVsZXRlU2hhcmUgPSBmdW5jdGlvbiAoc2hhcmUpIHtcclxuICAgICAgICAgICAgc2hhcmVTZXJ2aWNlLmRlbGV0ZVNoYXJlKHNoYXJlLCBmdW5jdGlvbihlcnIsIGRhdGEpIHtcclxuICAgICAgICAgICAgICAgIGlmKCFlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICAkc2NvcGUuc2hhcmVzQWRtaW4uc3BsaWNlKCRzY29wZS5zaGFyZXNBZG1pbi5pbmRleE9mKHNoYXJlKSwgMSk7XHJcbiAgICAgICAgICAgICAgICAgICAgd2luZG93LmFsZXJ0KGRhdGEubWVzc2FnZSk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBTaGFyZVNlcnZpY2VFeGNlcHRpb24oZXJyKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfTtcclxuICAgIH07XHJcblxyXG4gICAgYW5ndWxhci5tb2R1bGUoXCJnZW9mZWVsaW5nc1wiKS5jb250cm9sbGVyKFwiYWRtaW5Db250cm9sbGVyXCIsIFtcIiRzY29wZVwiLCBcIiRsb2NhdGlvblwiLCBcImV2ZW50U2VydmljZVwiLCBcInNoYXJlU2VydmljZVwiLCBcInByb2ZpbGVTZXJ2aWNlXCIsIGFkbWluQ29udHJvbGxlcl0pO1xyXG59KSgpOyIsIi8qKlxyXG4gKiBDcmVhdGVkIGJ5IEpvbmF0YW4gb24gMzAvMTIvMjAxNS5cclxuICovXHJcblxyXG4oZnVuY3Rpb24gKCkge1xyXG4gICAgXCJ1c2Ugc3RyaWN0XCI7XHJcblxyXG4gICAgdmFyIGFkZEV2ZW50Q29udHJvbGxlciA9IGZ1bmN0aW9uICgkc2NvcGUsICRsb2NhdGlvbiwgZXZlbnRTZXJ2aWNlLCBwcm9maWxlU2VydmljZSkge1xyXG4gICAgICAgICRzY29wZS5uZXdFdmVudCA9IHt9O1xyXG4gICAgICAgICRzY29wZS5lcnJvckFkZEV2ZW50ID0gbnVsbDtcclxuXHJcbiAgICAgICAgcHJvZmlsZVNlcnZpY2UuZ2V0VXNlcihmdW5jdGlvbihlcnIsIHVzZXIpIHtcclxuICAgICAgICAgICAgaWYoIWVycikge1xyXG4gICAgICAgICAgICAgICAgaWYodXNlci5yZWRpcmVjdCkge1xyXG4gICAgICAgICAgICAgICAgICAgICRsb2NhdGlvbi5wYXRoKHVzZXIucmVkaXJlY3QpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAkc2NvcGUubmV3RXZlbnQuYXV0aG9yaWQgPSB1c2VyLmlkO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IFByb2ZpbGVTZXJ2aWNlRXhjZXB0aW9uKGVycik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgJHNjb3BlLmNyZWF0ZUV2ZW50ID0gZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgICRzY29wZS5uZXdFdmVudC5hZGRyZXNzID0gbWFrZUFkZHJlc3MoJHNjb3BlLm5ld0V2ZW50LmFkZHJlc3MxLCAkc2NvcGUubmV3RXZlbnQuYWRkcmVzczIpO1xyXG4gICAgICAgICAgICBldmVudFNlcnZpY2UucG9zdEV2ZW50KCRzY29wZS5uZXdFdmVudCwgZnVuY3Rpb24gKGVyciwgZGF0YSkge1xyXG4gICAgICAgICAgICAgICAgaWYoIWVycikge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmKGRhdGEucmVkaXJlY3QpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgJGxvY2F0aW9uLnBhdGgoZGF0YS5yZWRpcmVjdCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmKGRhdGEuZXJyb3IpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgJHNjb3BlLmVycm9yQWRkRXZlbnQgPSBkYXRhLmVycm9yO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICRsb2NhdGlvbi5wYXRoKFwiL2V2ZW50L1wiICsgZGF0YS5ldmVudC5faWQpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYoZXJyID09PSBcIlpFUk9fUkVTVUxUU1wiKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZS5lcnJvckFkZEV2ZW50ID0gXCJObyBhZGRyZXNzIGZvdW5kISBTdHJlZXQgJiBOdW1iZXIgYW5kIFppcCAmIENpdHkgYXJlIHJlcXVpcmVkISBNYWtlIHN1cmUgdGhlciBpcyBhIHNwYWNlIGJldHdlZW4geW91ciBpbnB1dCBhbmQgbm8gLFwiO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZS5lcnJvckFkZEV2ZW50ID0gXCJTb21ldGhpbmcgd2VudCB3cm9uZywgdHJ5IGFnYWluIGxhdGVyIVwiO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgdmFyIG1ha2VBZGRyZXNzID0gZnVuY3Rpb24gKGFkZHJlc3MxLCBhZGRyZXNzMikge1xyXG4gICAgICAgICAgICByZXR1cm4gYWRkcmVzczEgKyBcIixcIiArIGFkZHJlc3MyO1xyXG4gICAgICAgIH07XHJcbiAgICB9O1xyXG5cclxuICAgIGFuZ3VsYXIubW9kdWxlKFwiZ2VvZmVlbGluZ3NcIikuY29udHJvbGxlcihcImFkZEV2ZW50Q29udHJvbGxlclwiLCBbXCIkc2NvcGVcIiwgXCIkbG9jYXRpb25cIiwgXCJldmVudFNlcnZpY2VcIiwgXCJwcm9maWxlU2VydmljZVwiLCBhZGRFdmVudENvbnRyb2xsZXJdKTtcclxufSkoKTsiLCIvKipcclxuICogQ3JlYXRlZCBieSBKb25hdGFuIG9uIDQvMTIvMjAxNS5cclxuICovXHJcblxyXG5cclxuKGZ1bmN0aW9uICgpIHtcclxuICAgIFwidXNlIHN0cmljdFwiO1xyXG5cclxuICAgIHZhciBldmVudENvbnRyb2xsZXIgPSBmdW5jdGlvbiAoJHNjb3BlLCAkbG9jYXRpb24sICRzY2UsICRyb3V0ZVBhcmFtcywgZXZlbnRTZXJ2aWNlLCBzaGFyZVNlcnZpY2UsIHByb2ZpbGVTZXJ2aWNlKSB7XHJcbiAgICAgICAgdmFyIGV2ZW50aWQgPSAkcm91dGVQYXJhbXMucGFyYW07XHJcbiAgICAgICAgJHNjb3BlLm5ld0V2ZW50ID0ge307XHJcblxyXG4gICAgICAgIGV2ZW50U2VydmljZS5nZXRFdmVudEJ5SWQoZXZlbnRpZCwgZnVuY3Rpb24oZXJyLCBldmVudCkge1xyXG4gICAgICAgICAgICBpZighZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAkc2NvcGUuZXZlbnQgPSBldmVudDtcclxuICAgICAgICAgICAgICAgICRzY29wZS5ldmVudC5tb29kID0gNTA7XHJcbiAgICAgICAgICAgICAgICAkc2NvcGUuZXZlbnQuZXZlbnRpZCA9IGV2ZW50LmlkO1xyXG4gICAgICAgICAgICAgICAgJHNjb3BlLmV2ZW50LmFkZHJlc3MxID0gc3BsaXRBZGRyZXNzKCRzY29wZS5ldmVudC5hZGRyZXNzLCAwKTtcclxuICAgICAgICAgICAgICAgICRzY29wZS5ldmVudC5hZGRyZXNzMiA9IHNwbGl0QWRkcmVzcygkc2NvcGUuZXZlbnQuYWRkcmVzcywgMSk7XHJcblxyXG4gICAgICAgICAgICAgICAgaWYoISRzY29wZS5ldmVudC5ldmVudGltYWdlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgJHNjb3BlLmV2ZW50LmV2ZW50aW1hZ2UgPSBcImh0dHA6Ly9zdHVkZW50Lmhvd2VzdC5iZS9qb25hdGFuLm1pY2hpZWxzL2dlb2ZlZWxpbmdzL2Fzc2V0cy9ldmVudC5wbmdcIjtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICBpZigkc2NvcGUuZXZlbnQuYXV0aG9yaWQpIHtcclxuICAgICAgICAgICAgICAgICAgICBwcm9maWxlU2VydmljZS5nZXRVc2VyKGZ1bmN0aW9uKGVyciwgdXNlcikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZighZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkc2NvcGUuZXZlbnQudXNlcmlkID0gdXNlci5pZDtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZih1c2VyLnJlZGlyZWN0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGxvY2F0aW9uLnBhdGgodXNlci5yZWRpcmVjdCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkc2NvcGUuZXZlbnQuYXV0aG9yaWQgPT09IHVzZXIuaWQ7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgUHJvZmlsZVNlcnZpY2VFeGNlcHRpb24oZXJyKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAkc2NvcGUuZXZlbnQuaXNBdXRob3IgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICBzaGFyZVNlcnZpY2UuZ2V0U2hhcmVzQnlFdmVudElkKGV2ZW50LmlkLCBmdW5jdGlvbihlcnIsIHNoYXJlcykge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmKCFlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYoc2hhcmVzLnJlZGlyZWN0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkbG9jYXRpb24ucGF0aChzaGFyZXMucmVkaXJlY3QpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoc2hhcmVzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkc2NvcGUuc2hhcmVzZm9yZXZlbnQgPSBzaGFyZXM7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZS5ub1NoYXJlc0ZvckV2ZW50ID0gXCI8ZGl2Pk5vIHNoYXJlcyBmb3IgdGhpcyBldmVudC48L2Rpdj5cIjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBTaGFyZVNlcnZpY2VFeGNlcHRpb24oZXJyKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFdmVudFNlcnZpY2VFeGNlcHRpb24oZXJyKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICAkc2NvcGUucmVuZGVySHRtbCA9IGZ1bmN0aW9uKGh0bWwpIHtcclxuICAgICAgICAgICAgcmV0dXJuICRzY2UudHJ1c3RBc0h0bWwoaHRtbCk7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgJHNjb3BlLnBvc3RTaGFyZSA9IGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICAgICAkc2NvcGUuZXZlbnQudGltZSA9IG5ldyBEYXRlKCk7XHJcbiAgICAgICAgICAgIHNoYXJlU2VydmljZS5wb3N0U2hhcmVBc3luYygkc2NvcGUuZXZlbnQsIGZ1bmN0aW9uKGVyciwgZGF0YSkge1xyXG4gICAgICAgICAgICAgICAgaWYoIWVycikge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmKGRhdGEucmVkaXJlY3QpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgJGxvY2F0aW9uLnBhdGgoZGF0YS5yZWRpcmVjdCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmKGRhdGEuZXJyb3IpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgJHNjb3BlLmVycm9yID0gZGF0YS5lcnJvcjtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAkc2NvcGUuZXZlbnQgPSBkYXRhO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYoZXJyID09PSBcIlpFUk9fUkVTVUxUU1wiKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZS5lcnJvciA9IFwiTm8gYWRkcmVzcyBmb3VuZCFcIjtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAkc2NvcGUuZXJyb3IgPSBcIlNvbWV0aGluZyB3ZW50IHdyb25nLCB0cnkgYWdhaW4gbGF0ZXIhXCI7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICAkc2NvcGUudXBkYXRlRXZlbnQgPSBmdW5jdGlvbigpIHtcclxuICAgICAgICAgICAgJHNjb3BlLmV2ZW50LmFkZHJlc3MgPSBtYWtlQWRkcmVzcygkc2NvcGUuZXZlbnQuYWRkcmVzczEsICRzY29wZS5ldmVudC5hZGRyZXNzMik7XHJcbiAgICAgICAgICAgIGV2ZW50U2VydmljZS51cGRhdGVFdmVudCgkc2NvcGUuZXZlbnQsIGZ1bmN0aW9uKGVyciwgZGF0YSkge1xyXG4gICAgICAgICAgICAgICAgaWYoIWVycikge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmKGRhdGEucmVkaXJlY3QpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgJGxvY2F0aW9uLnBhdGgoZGF0YS5yZWRpcmVjdCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmKGRhdGEuZXJyb3IpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgJHNjb3BlLmVycm9yRXZlbnQgPSBkYXRhLmVycm9yO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZS5ldmVudCA9IGRhdGE7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZS5ldmVudC5hZGRyZXNzMSA9IHNwbGl0QWRkcmVzcygkc2NvcGUuZXZlbnQuYWRkcmVzcywgMCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZS5ldmVudC5hZGRyZXNzMiA9IHNwbGl0QWRkcmVzcygkc2NvcGUuZXZlbnQuYWRkcmVzcywgMSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBpZihlcnIgPT09IFwiWkVST19SRVNVTFRTXCIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgJHNjb3BlLmVycm9yRXZlbnQgPSBcIk5vIGFkZHJlc3MgZm91bmQhIFN0cmVldCAmIE51bWJlciBhbmQgWmlwICYgQ2l0eSBhcmUgcmVxdWlyZWQhIE1ha2Ugc3VyZSB0aGVyIGlzIGEgc3BhY2UgYmV0d2VlbiB5b3VyIGlucHV0IGFuZCBubyBrb21tYSgsKVwiO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZS5lcnJvckV2ZW50ID0gXCJTb21ldGhpbmcgd2VudCB3cm9uZywgdHJ5IGFnYWluIGxhdGVyIVwiO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgJHNjb3BlLmNvbnZlcnRNb29kID0gZnVuY3Rpb24obW9vZCkge1xyXG4gICAgICAgICAgICBpZihtb29kID4gODApIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBcImV4Y2l0ZWRcIjtcclxuICAgICAgICAgICAgfSBlbHNlIGlmKG1vb2QgPiA2MCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIFwiaGFwcHlcIjtcclxuICAgICAgICAgICAgfSBlbHNlIGlmKG1vb2QgPiA0MCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIFwiY29tbW9uXCI7XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAobW9vZCA+IDIwKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gXCJzYWRcIjtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBcImRlcHJlc3NpdmVcIjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHZhciBzcGxpdEFkZHJlc3MgPSBmdW5jdGlvbiAoYWRkcmVzcywgcGFydCkge1xyXG4gICAgICAgICAgICB2YXIgc3BsaXQgPSBhZGRyZXNzLnNwbGl0KFwiLFwiKTtcclxuICAgICAgICAgICAgcmV0dXJuIHNwbGl0W3BhcnRdO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHZhciBtYWtlQWRkcmVzcyA9IGZ1bmN0aW9uIChhZGRyZXNzMSwgYWRkcmVzczIpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGFkZHJlc3MxICsgXCIsXCIgKyBhZGRyZXNzMjtcclxuICAgICAgICB9O1xyXG4gICAgfTtcclxuXHJcbiAgICBhbmd1bGFyLm1vZHVsZShcImdlb2ZlZWxpbmdzXCIpLmNvbnRyb2xsZXIoXCJldmVudENvbnRyb2xsZXJcIiwgW1wiJHNjb3BlXCIsIFwiJGxvY2F0aW9uXCIsIFwiJHNjZVwiLCBcIiRyb3V0ZVBhcmFtc1wiLCBcImV2ZW50U2VydmljZVwiLCBcInNoYXJlU2VydmljZVwiLCBcInByb2ZpbGVTZXJ2aWNlXCIsIGV2ZW50Q29udHJvbGxlcl0pO1xyXG59KSgpOyIsIi8qKlxyXG4gKiBDcmVhdGVkIGJ5IEpvbmF0YW4gb24gMS8xMi8yMDE1LlxyXG4gKi9cclxuXHJcbihmdW5jdGlvbiAoKSB7XHJcbiAgICBcInVzZSBzdHJpY3RcIjtcclxuXHJcbiAgICB2YXIgaW50cm9Db250cm9sbGVyID0gZnVuY3Rpb24gKCRzY29wZSwgc2hhcmVTZXJ2aWNlLCAkaHR0cCwgJGxvY2F0aW9uLCBwcm9maWxlU2VydmljZSwgc2hhcmVWYXJzQmV0d2VlbkN0cmwsIGdvb2dsZU1hcHNTZXJ2aWNlKSB7XHJcblxyXG4gICAgICAgIHZhciBzb2NrZXQgPSBpby5jb25uZWN0KFwiaHR0cDovL2xvY2FsaG9zdDozMDAxXCIpO1xyXG5cclxuICAgICAgICAvL1NNSUxFWSBURUtFTkVOXHJcbiAgICAgICAgJHNjb3BlLnNsaWRlclZhbHVlID0gNTA7XHJcbiAgICAgICAgJHNjb3BlLm1vb2RXb3JkID0gbnVsbDtcclxuICAgICAgICB2YXIgYyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwic21pbGV5Q2FudmFzXCIpO1xyXG4gICAgICAgIHZhciBjdHggPSBjLmdldENvbnRleHQoXCIyZFwiKTtcclxuXHJcbiAgICAgICAgdmFyIHNhZFJHQiA9IFsxNTIsIDMwLCAzMF07XHJcbiAgICAgICAgdmFyIGhhcHB5UkdCID0gWzcwLCAxNjEsIDczXTtcclxuXHJcbiAgICAgICAgLy90ZWxrZW5zIHNsaWRlcnZhbHVlIHZlcmFuZGVydCBnZXppY2h0amUgdGVrZW5lblxyXG4gICAgICAgICRzY29wZS4kd2F0Y2goXCJzbGlkZXJWYWx1ZVwiLCBmdW5jdGlvbiAoKSB7XHJcblxyXG4gICAgICAgICAgICBjdHguY2xlYXJSZWN0KDAsIDAsIGMud2lkdGgsIGMuaGVpZ2h0KTsgLy9jYW52YXMgY2xlYXJlbiB2b29yIG5pZXV3IGZyYW1lXHJcblxyXG4gICAgICAgICAgICB2YXIgbW9vZCA9ICRzY29wZS5zbGlkZXJWYWx1ZTtcclxuICAgICAgICAgICAgZ2l2ZU1vb2RXb3JkKCk7XHJcbiAgICAgICAgICAgIC8vb2Zmc2V0IHBvc2l0aWUgbW9uZFxyXG4gICAgICAgICAgICB2YXIgb2Zmc2V0WCA9IGMud2lkdGggLyA1O1xyXG4gICAgICAgICAgICB2YXIgb2ZmU2V0WSA9IGMud2lkdGggLyAyLjE0ICsgKG1vb2QgLyAoYy53aWR0aCAvIDYpKTtcclxuXHJcbiAgICAgICAgICAgIC8vdmFyaWFiZWxlbiB2b29yIGJlemllcmN1cnZlICg9IG1vbmQpXHJcbiAgICAgICAgICAgIHZhciBTUHggPSBvZmZzZXRYO1xyXG4gICAgICAgICAgICB2YXIgU1B5ID0gb2ZmU2V0WSArIGMud2lkdGggLyAzIC0gKG1vb2QgKiAoYy53aWR0aCAvIDM3Ni42NikpO1xyXG4gICAgICAgICAgICB2YXIgSDF4ID0gb2Zmc2V0WDtcclxuICAgICAgICAgICAgdmFyIEgxeSA9IG9mZlNldFkgKyAobW9vZCAqIChjLndpZHRoIC8gMjUwKSk7XHJcbiAgICAgICAgICAgIHZhciBIMnggPSBvZmZzZXRYICsgKChjLndpZHRoIC8gMzAwKSAqIDE4MCk7XHJcbiAgICAgICAgICAgIHZhciBIMnkgPSBvZmZTZXRZICsgKG1vb2QgKiAoYy53aWR0aCAvIDI1MCkpO1xyXG4gICAgICAgICAgICB2YXIgRVB4ID0gb2Zmc2V0WCArIChjLndpZHRoIC8gMS42NjYpO1xyXG4gICAgICAgICAgICB2YXIgRVB5ID0gb2ZmU2V0WSArIChjLndpZHRoIC8gMykgLSAobW9vZCAqIChjLndpZHRoIC8gMzc2LjY2KSk7XHJcblxyXG4gICAgICAgICAgICAvL2hvb2ZkXHJcbiAgICAgICAgICAgIGN0eC5saW5lV2lkdGggPSBjLndpZHRoIC8gNjA7XHJcbiAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTtcclxuICAgICAgICAgICAgY3R4LmFyYygoYy53aWR0aCAvIDIpLCAoYy53aWR0aCAvIDIpLCAoYy53aWR0aCAvIDIuMDcpLCAwLCAyICogTWF0aC5QSSk7XHJcbiAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSBcInJnYihcIiArIG1vb2RDb2xvcigwKSArIFwiLFwiICsgbW9vZENvbG9yKDEpICsgXCIsXCIgKyBtb29kQ29sb3IoMikgKyBcIilcIjtcclxuICAgICAgICAgICAgY3R4LmZpbGwoKTtcclxuICAgICAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gJ3doaXRlJztcclxuICAgICAgICAgICAgY3R4LnN0cm9rZSgpO1xyXG5cclxuICAgICAgICAgICAgLy9tb25kXHJcblxyXG4gICAgICAgICAgICBjdHgubGluZVdpZHRoID0gYy53aWR0aCAvIDMwO1xyXG4gICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7XHJcbiAgICAgICAgICAgIGN0eC5tb3ZlVG8oU1B4LCBTUHkpO1xyXG4gICAgICAgICAgICBjdHguYmV6aWVyQ3VydmVUbyhIMXgsIEgxeSwgSDJ4LCBIMnksIEVQeCwgRVB5KTtcclxuICAgICAgICAgICAgLy9jdHguc3Ryb2tlU3R5bGUgPSAnYmxhY2snO1xyXG4gICAgICAgICAgICBjdHguc3Ryb2tlKCk7XHJcbiAgICAgICAgICAgIGN0eC5saW5lQ2FwID0gXCJyb3VuZFwiO1xyXG5cclxuICAgICAgICAgICAgLy9vb2cgbGlua3NcclxuXHJcbiAgICAgICAgICAgIGN0eC5saW5lV2lkdGggPSBjLndpZHRoIC8gNjA7XHJcbiAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTtcclxuICAgICAgICAgICAgY3R4LmFyYyhjLndpZHRoIC8gMywgYy53aWR0aCAvIDMsIGMud2lkdGggLyAxNSwgMCwgMiAqIE1hdGguUEkpO1xyXG4gICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gJ3doaXRlJztcclxuICAgICAgICAgICAgY3R4LmZpbGwoKTtcclxuICAgICAgICAgICAgY3R4LnN0cm9rZSgpO1xyXG5cclxuICAgICAgICAgICAgLy9vb2cgcmVjaHRzXHJcbiAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTtcclxuICAgICAgICAgICAgY3R4LmFyYyhjLndpZHRoIC8gMyAqIDIsIGMud2lkdGggLyAzLCBjLndpZHRoIC8gMTUsIDAsIDIgKiBNYXRoLlBJKTtcclxuICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICd3aGl0ZSc7XHJcbiAgICAgICAgICAgIGN0eC5maWxsKCk7XHJcbiAgICAgICAgICAgIGN0eC5zdHJva2UoKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgdmFyIG1vb2RDb2xvciA9IGZ1bmN0aW9uIChjKSB7XHJcbiAgICAgICAgICAgIC8vYzogUiA9IDAsIEcgPSAxLCBCID0gMlxyXG5cclxuICAgICAgICAgICAgaWYgKHNhZFJHQltjXSA+IGhhcHB5UkdCW2NdKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gTWF0aC5yb3VuZChzYWRSR0JbY10gLSAoKHNhZFJHQltjXSAtIGhhcHB5UkdCW2NdKSAqICgkc2NvcGUuc2xpZGVyVmFsdWUgLyAxMDApKSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gTWF0aC5yb3VuZChzYWRSR0JbY10gKyAoKGhhcHB5UkdCW2NdIC0gc2FkUkdCW2NdKSAqICgkc2NvcGUuc2xpZGVyVmFsdWUgLyAxMDApKSk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgdmFyIG1vb2R3b3JkcyA9IFtcImhvcnJpYmxlXCIsIFwicmVhbGx5IGJhZFwiLCBcImJhZFwiLCBcIm9rYXlcIiwgXCJnb29kXCIsIFwicmVhbGx5IGdvb2RcIiwgXCJleGNlbGxlbnRcIl07XHJcblxyXG4gICAgICAgIHZhciBnaXZlTW9vZFdvcmQgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIGlmICgkc2NvcGUuc2xpZGVyVmFsdWUgPCA1KSB7XHJcbiAgICAgICAgICAgICAgICAkc2NvcGUubW9vZFdvcmQgPSBtb29kd29yZHNbMF07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSBpZiAoJHNjb3BlLnNsaWRlclZhbHVlIDwgMjUpIHtcclxuICAgICAgICAgICAgICAgICRzY29wZS5tb29kV29yZCA9IG1vb2R3b3Jkc1sxXTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIGlmICgkc2NvcGUuc2xpZGVyVmFsdWUgPCA0MCkge1xyXG4gICAgICAgICAgICAgICAgJHNjb3BlLm1vb2RXb3JkID0gbW9vZHdvcmRzWzJdO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2UgaWYgKCRzY29wZS5zbGlkZXJWYWx1ZSA8IDYwKSB7XHJcbiAgICAgICAgICAgICAgICAkc2NvcGUubW9vZFdvcmQgPSBtb29kd29yZHNbM107XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSBpZiAoJHNjb3BlLnNsaWRlclZhbHVlIDwgNzUpIHtcclxuICAgICAgICAgICAgICAgICRzY29wZS5tb29kV29yZCA9IG1vb2R3b3Jkc1s0XTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIGlmICgkc2NvcGUuc2xpZGVyVmFsdWUgPCA5NSkge1xyXG4gICAgICAgICAgICAgICAgJHNjb3BlLm1vb2RXb3JkID0gbW9vZHdvcmRzWzVdO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgJHNjb3BlLm1vb2RXb3JkID0gbW9vZHdvcmRzWzZdO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgJGh0dHAuZ2V0KCcvYXV0aC91c2VyJykuc3VjY2VzcyhmdW5jdGlvbiAoZGF0YSkge1xyXG4gICAgICAgICAgICAkc2NvcGUudXNlciA9IGRhdGE7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgJHNjb3BlLnNoYXJlUG9zdGVkID0gZmFsc2U7XHJcblxyXG4gICAgICAgICRzY29wZS5wb3N0U2hhcmUgPSBmdW5jdGlvbiAoKSB7XHJcblxyXG4gICAgICAgICAgICAkc2NvcGUuc2hhcmVQb3N0ZWQgPSB0cnVlOyAvL3pvcmd0IGVydm9vciBkYXQgc3Bpbm5lcnRqZSBiZWdpbnQgZGUgZHJhYWllblxyXG5cclxuICAgICAgICAgICAgcHJvZmlsZVNlcnZpY2UuZ2V0VXNlcihmdW5jdGlvbiAoZXJyLCB1c2VyRGF0YSkge1xyXG4gICAgICAgICAgICAgICAgaWYgKCFlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAodXNlckRhdGEucmVkaXJlY3QpIHsgLy91c2VyIGlzIG5vZyBuaWV0IGluZ2Vsb2dkIGJpaiBoZXQgc2hhcmVuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG5hdmlnYXRvci5nZW9sb2NhdGlvbi5nZXRDdXJyZW50UG9zaXRpb24oZnVuY3Rpb24gKHBvc2l0aW9uKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBnb29nbGVNYXBzU2VydmljZS5jb252ZXJ0Q29vcmRpbmF0ZXNUb0FkcmVzcyhwb3NpdGlvbi5jb29yZHMubGF0aXR1ZGUsIHBvc2l0aW9uLmNvb3Jkcy5sb25naXR1ZGUsIGZ1bmN0aW9uIChlcnIsIGFkZHJlc3MpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWVycikge1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHNoYXJlQWRkcmVzcztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2hhcmVBZGRyZXNzID0gXCJcIjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNoYXJlQWRkcmVzcyA9IGFkZHJlc3M7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB1c2VybGVzc1NoYXJlRGF0YSA9IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwidXNlcmlkXCI6IDAsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcImV2ZW50aWRcIjogbnVsbCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwidGltZVwiOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIm1vb2RcIjogJHNjb3BlLnNsaWRlclZhbHVlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJsYXRcIjogcG9zaXRpb24uY29vcmRzLmxhdGl0dWRlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJsbmdcIjogcG9zaXRpb24uY29vcmRzLmxvbmdpdHVkZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiYWRkcmVzc1wiOiBzaGFyZUFkZHJlc3MsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcInJlYXNvblwiOiAkc2NvcGUubW9vZFJlYXNvblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaGFyZVZhcnNCZXR3ZWVuQ3RybC5zYXZlVXNlcmxlc3NTaGFyZSh1c2VybGVzc1NoYXJlRGF0YSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcImVycm9rZTogXCIgKyBlcnIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc2hhcmVWYXJzQmV0d2VlbkN0cmwuc2V0RXh0cmFMb2dpbkluZm8oXCJQbGVhc2UgbG9naW4gYmVmb3JlIHBvc3RpbmcgdGhpcyBzaGFyZS5cIik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICRsb2NhdGlvbi5wYXRoKHVzZXJEYXRhLnJlZGlyZWN0KTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbmF2aWdhdG9yLmdlb2xvY2F0aW9uLmdldEN1cnJlbnRQb3NpdGlvbihmdW5jdGlvbiAocG9zaXRpb24pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdvb2dsZU1hcHNTZXJ2aWNlLmNvbnZlcnRDb29yZGluYXRlc1RvQWRyZXNzKHBvc2l0aW9uLmNvb3Jkcy5sYXRpdHVkZSwgcG9zaXRpb24uY29vcmRzLmxvbmdpdHVkZSwgZnVuY3Rpb24gKGVyciwgYWRkcmVzcykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzaGFyZUFkZHJlc3M7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaGFyZUFkZHJlc3MgPSBcIlwiO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2hhcmVBZGRyZXNzID0gYWRkcmVzcztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzaGFyZURhdGEgPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwidXNlcmlkXCI6IHVzZXJEYXRhLmlkLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcImV2ZW50aWRcIjogbnVsbCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJ0aW1lXCI6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJtb29kXCI6ICRzY29wZS5zbGlkZXJWYWx1ZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJsYXRcIjogcG9zaXRpb24uY29vcmRzLmxhdGl0dWRlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcImxuZ1wiOiBwb3NpdGlvbi5jb29yZHMubG9uZ2l0dWRlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcImFkZHJlc3NcIjogc2hhcmVBZGRyZXNzLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcInJlYXNvblwiOiAkc2NvcGUubW9vZFJlYXNvblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNoYXJlU2VydmljZS5wb3N0U2hhcmVBc3luYyhzaGFyZURhdGEsIGZ1bmN0aW9uIChlcnIsIHJlc1NoYXJlRGF0YSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWVycikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc29ja2V0LmVtaXQoXCJzaGFyZVBvc3RlZFwiLCByZXNTaGFyZURhdGEpOyAvL3VpdHplbmRlbiBuYWFyIGllZGVyZWVuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaGFyZVZhcnNCZXR3ZWVuQ3RybC5zZXRQcm9wZXJ0eShyZXNTaGFyZURhdGEpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGxvY2F0aW9uLnBhdGgoXCIvaW50cm9fc2hhcmVkXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coZXJyKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiZXJyb3Igd2hpbGUgZ2V0dGluZyB1c2VyOiBcIiArIGVycik7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcbiAgICB9O1xyXG5cclxuICAgIGFuZ3VsYXIubW9kdWxlKFwiZ2VvZmVlbGluZ3NcIikuY29udHJvbGxlcihcImludHJvQ29udHJvbGxlclwiLCBbXCIkc2NvcGVcIiwgXCJzaGFyZVNlcnZpY2VcIiwgXCIkaHR0cFwiLCBcIiRsb2NhdGlvblwiLCBcInByb2ZpbGVTZXJ2aWNlXCIsIFwic2hhcmVWYXJzQmV0d2VlbkN0cmxcIiwgXCJnb29nbGVNYXBzU2VydmljZVwiLCBpbnRyb0NvbnRyb2xsZXJdKTtcclxufSkoKTsiLCIvKipcclxuICogQ3JlYXRlZCBieSBMaWVuZXJ0IG9uIDIxLzEyLzIwMTUuXHJcbiAqL1xyXG5cclxuKGZ1bmN0aW9uICgpIHtcclxuICAgIFwidXNlIHN0cmljdFwiO1xyXG5cclxuICAgIHZhciBpbnRyb19zaGFyZWRDb250cm9sbGVyID0gZnVuY3Rpb24gKCRzY29wZSwgc2hhcmVWYXJzQmV0d2VlbkN0cmwpIHtcclxuICAgICAgICAkc2NvcGUuaW5mb1Bvc3RlZFNoYXJlID0gc2hhcmVWYXJzQmV0d2VlbkN0cmwuZ2V0UHJvcGVydHkoKTtcclxuICAgIH07XHJcbiAgICBhbmd1bGFyLm1vZHVsZShcImdlb2ZlZWxpbmdzXCIpLmNvbnRyb2xsZXIoXCJpbnRyb19zaGFyZWRDb250cm9sbGVyXCIsIFtcIiRzY29wZVwiLCBcInNoYXJlVmFyc0JldHdlZW5DdHJsXCIsIGludHJvX3NoYXJlZENvbnRyb2xsZXJdKTtcclxufSkoKTsiLCIvKipcclxuICogQ3JlYXRlZCBieSBKb25hdGFuIG9uIDI2LzExLzIwMTUuXHJcbiAqL1xyXG5cclxuKGZ1bmN0aW9uICgpIHtcclxuICAgIFwidXNlIHN0cmljdFwiO1xyXG5cclxuICAgIHZhciBzb2NrZXQgPSBpby5jb25uZWN0KFwiaHR0cDovL2xvY2FsaG9zdDozMDAxXCIpO1xyXG5cclxuICAgIHZhciBsb2dpbkNvbnRyb2xsZXIgPSBmdW5jdGlvbiAoJHNjb3BlLCAkaHR0cCwgJGxvY2F0aW9uLCBzaGFyZVZhcnNCZXR3ZWVuQ3RybCwgc2hhcmVTZXJ2aWNlLCBwcm9maWxlU2VydmljZSkge1xyXG4gICAgICAgIGlmIChzaGFyZVZhcnNCZXR3ZWVuQ3RybC5nZXRFeHRyYUxvZ2luSW5mbygpKSB7XHJcbiAgICAgICAgICAgICRzY29wZS5leHRyYUxvZ2luSW5mbyA9IHNoYXJlVmFyc0JldHdlZW5DdHJsLmdldEV4dHJhTG9naW5JbmZvKCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB2YXIgcG9zdFVzZXJsZXNzU2hhcmUgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHZhciBzaGFyZURhdGEgPSBzaGFyZVZhcnNCZXR3ZWVuQ3RybC5yZXR1cm5Vc2VybGVzc1NoYXJlKCk7XHJcbiAgICAgICAgICAgIHByb2ZpbGVTZXJ2aWNlLmdldFVzZXIoZnVuY3Rpb24gKGVyciwgdXNlcikge1xyXG4gICAgICAgICAgICAgICAgaWYgKCFlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAodXNlci5yZWRpcmVjdCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAkbG9jYXRpb24ucGF0aCh1c2VyLnJlZGlyZWN0KTtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzaGFyZURhdGEudXNlcmlkID0gdXNlci5pZDtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNoYXJlU2VydmljZS5wb3N0U2hhcmVBc3luYyhzaGFyZURhdGEsIGZ1bmN0aW9uIChlcnIsIHJlc1NoYXJlRGF0YSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaGFyZVZhcnNCZXR3ZWVuQ3RybC5zZXRFeHRyYUxvZ2luSW5mbyhcIlwiKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaGFyZVZhcnNCZXR3ZWVuQ3RybC5zZXRQcm9wZXJ0eShyZXNTaGFyZURhdGEpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRsb2NhdGlvbi5wYXRoKFwiL2ludHJvX3NoYXJlZFwiKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGVycik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pOyAvL3Bvc3QgZGUgc2hhcmUgbWV0IGRlIGlubG9nZGF0YSBkYXQgaGlqIG51IHdlZXRcclxuICAgICAgICAgICAgICAgICAgICAgICAgc2hhcmVWYXJzQmV0d2VlbkN0cmwuc2F2ZVVzZXJsZXNzU2hhcmUoXCJcIik7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIj4gZXJyb3IgcHJvZmlsZVNlcnZpY2U6IFwiICsgZXJyKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgLy9Nb2V0IG5vZyBuYWFyIGVlbiBzZXJ2aWNlIG9tZ2V6ZXQgd29yZGVuXHJcbiAgICAgICAgJHNjb3BlLmxvZ2luID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAkaHR0cC5wb3N0KCdodHRwOi8vbG9jYWxob3N0OjMwMDAvYXV0aC9sb2dpbicsIHtcclxuICAgICAgICAgICAgICAgIHVzZXJuYW1lOiAkc2NvcGUudXNlcm5hbWUsXHJcbiAgICAgICAgICAgICAgICBwYXNzd29yZDogJHNjb3BlLnBhc3N3b3JkXHJcbiAgICAgICAgICAgIH0pLnN1Y2Nlc3MoZnVuY3Rpb24gKGRhdGEpIHtcclxuICAgICAgICAgICAgICAgICRzY29wZS5lcnJvciA9IGRhdGEuZXJyb3I7XHJcblxyXG4gICAgICAgICAgICAgICAgcHJvZmlsZVNlcnZpY2UuZ2V0VXNlcihmdW5jdGlvbiAoZXJyLCB1c2VyRGF0YSkgeyAvL3plbmQgamUgaWQgbmFhciBkZSBzZXJ2ZXIgb20gdGUgemVnZ2VuIGRhdCBqZSBlciBiZW50IGVuIHdlbGsgc29ja2V0aWQgamUgaGVidFxyXG4gICAgICAgICAgICAgICAgICAgIGlmICghZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh1c2VyRGF0YS5yZWRpcmVjdCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy91c2VyaWQgbmlldCBsb2dnZWQgaW4sIG5vZyB0b2V2b2VnZW4gZGF0IGhpaiB6ZW4gaWQgc3R1dXJ0IGJpaiBpbmxvZ2dlbiFcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKHVzZXJEYXRhKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNvY2tldC5lbWl0KFwibG9naW5NZXNzYWdlXCIsIHVzZXJEYXRhLmlkKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiZXJyb3Igd2hpbGUgZ2V0dGluZyB1c2VyaWQ6IFwiICsgZXJyKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICAgICBpZiAoc2hhcmVWYXJzQmV0d2VlbkN0cmwucmV0dXJuVXNlcmxlc3NTaGFyZSgpICE9PSB1bmRlZmluZWQgJiYgc2hhcmVWYXJzQmV0d2VlbkN0cmwucmV0dXJuVXNlcmxlc3NTaGFyZSgpICE9PSBcIlwiKSAvL3VzZXJpZCBoZWVmdCB3aWxsZW4gc2hhcmVuLCBtYWFyIHdhcyBuaWV0IGluZ2Vsb2dkLlxyXG4gICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgIHBvc3RVc2VybGVzc1NoYXJlKCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAkbG9jYXRpb24ucGF0aChkYXRhLnJlZGlyZWN0KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgLy9Nb2V0IG5vZyBuYWFyIGVlbiBzZXJ2aWNlIG9tZ2V6ZXQgd29yZGVuXHJcbiAgICAgICAgJHNjb3BlLnJlZ2lzdGVyID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAkaHR0cC5wb3N0KCdodHRwOi8vbG9jYWxob3N0OjMwMDAvYXV0aC9yZWdpc3RlcicsIHtcclxuICAgICAgICAgICAgICAgIHVzZXJuYW1lOiAkc2NvcGUudXNlcm5hbWUsXHJcbiAgICAgICAgICAgICAgICBwYXNzd29yZDogJHNjb3BlLnBhc3N3b3JkLFxyXG4gICAgICAgICAgICAgICAgZW1haWw6ICRzY29wZS5lbWFpbFxyXG4gICAgICAgICAgICB9KS5zdWNjZXNzKGZ1bmN0aW9uIChkYXRhKSB7XHJcbiAgICAgICAgICAgICAgICAkc2NvcGUuZXJyb3IgPSBkYXRhLmVycm9yO1xyXG4gICAgICAgICAgICAgICAgaWYgKHNoYXJlVmFyc0JldHdlZW5DdHJsLnJldHVyblVzZXJsZXNzU2hhcmUoKSAhPT0gdW5kZWZpbmVkICYmIHNoYXJlVmFyc0JldHdlZW5DdHJsLnJldHVyblVzZXJsZXNzU2hhcmUoKSAhPT0gXCJcIikgLy91c2VyaWQgaGVlZnQgd2lsbGVuIHNoYXJlbiwgbWFhciB3YXMgbmlldCBpbmdlbG9nZC5cclxuICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICBwb3N0VXNlcmxlc3NTaGFyZSgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgJGxvY2F0aW9uLnBhdGgoZGF0YS5yZWRpcmVjdCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcbiAgICB9O1xyXG5cclxuICAgIGFuZ3VsYXIubW9kdWxlKFwiZ2VvZmVlbGluZ3NcIikuY29udHJvbGxlcihcImxvZ2luQ29udHJvbGxlclwiLCBbXCIkc2NvcGVcIiwgXCIkaHR0cFwiLCBcIiRsb2NhdGlvblwiLCBcInNoYXJlVmFyc0JldHdlZW5DdHJsXCIsIFwic2hhcmVTZXJ2aWNlXCIsIFwicHJvZmlsZVNlcnZpY2VcIiwgbG9naW5Db250cm9sbGVyXSk7XHJcbn0pKCk7IiwiLyoqXHJcbiAqIENyZWF0ZWQgYnkgSm9uYXRhbiBvbiAyMS8xMS8yMDE1LlxyXG4gKi9cclxuXHJcbihmdW5jdGlvbiAoKSB7XHJcbiAgICBcInVzZSBzdHJpY3RcIjtcclxuXHJcbiAgICB2YXIgbWFpbkNvbnRyb2xsZXIgPSBmdW5jdGlvbiAoJHNjb3BlLCBnb29nbGVNYXBzU2VydmljZSwgc2hhcmVTZXJ2aWNlLCBwcm9maWxlU2VydmljZSwgJGxvY2F0aW9uLCAkcm91dGVQYXJhbXMpIHtcclxuXHJcblxyXG4gICAgICAgIHZhciBzb2NrZXQgPSBpby5jb25uZWN0KFwiaHR0cDovL2xvY2FsaG9zdDozMDAxXCIpO1xyXG4gICAgICAgICRzY29wZS5jaGF0TWVzc2FnZXMgPSBbXTsgXHJcblxyXG5cclxuICAgICAgICAkc2NvcGUuaW5pdCA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgcHJvZmlsZVNlcnZpY2UuZ2V0VXNlcihmdW5jdGlvbiAoZXJyLCB1c2VyRGF0YSkgeyAvL3plbmQgamUgaWQgbmFhciBkZSBzZXJ2ZXIgb20gdGUgemVnZ2VuIGRhdCBqZSBlciBiZW50IGVuIHdlbGsgc29ja2V0aWQgamUgaGVidFxyXG4gICAgICAgICAgICAgICAgaWYgKCFlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAodXNlckRhdGEucmVkaXJlY3QpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy91c2VyaWQgbmlldCBsb2dnZWQgaW4sIG5vZyB0b2V2b2VnZW4gZGF0IGhpaiB6ZW4gaWQgc3R1dXJ0IGJpaiBpbmxvZ2dlbiFcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzb2NrZXQuZW1pdChcImxvZ2luTWVzc2FnZVwiLCB1c2VyRGF0YS5pZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcImVycm9yIHdoaWxlIGdldHRpbmcgdXNlcjogXCIgKyBlcnIpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICBzb2NrZXQub24oXCJzaGFyZVBvc3RlZE5vdGlmeVwiLCBmdW5jdGlvbiAoc2hhcmVkYXRhKSB7XHJcbiAgICAgICAgICAgIGdvb2dsZU1hcHNTZXJ2aWNlLnNob3dPbmVQb3N0TWFya2VyKHNoYXJlZGF0YSk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHNvY2tldC5vbihcImNoYXRNZXNzYWdlXCIsIGZ1bmN0aW9uIChkYXRhKSB7IC8vb250dmFuZ2VuIGJlcmljaHRcclxuICAgICAgICAgICAgJHNjb3BlLmNoYXRNZXNzYWdlcy5wdXNoKHt0ZXh0OiBkYXRhLnRleHQsIHNlbmRlcjogZGF0YS5zZW5kZXJVc2VybmFtZSwgY3NzQ2xhc3M6IFwib3RoZXJcIn0pOyAvL3B1c2hlbiBuYWFyIHNjb3BlIG9tIGNoYXRidWJibGUgdGUgdG9uZW5cclxuICAgICAgICAgICAgJHNjb3BlLiRhcHBseSgpOyAvL2RpdCB6b3JndCBlcnZvb3IgZGF0IGRlIGNoYXRidWJibGVzIGVyIGRpcmVjdCBrb21lbiwgbmlldCB2ZXJwbGFhdHNlbiFcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgJHNjb3BlLnNlbmRDaGF0TXNnVG9TZXJ2ZXIgPSBmdW5jdGlvbiAoKSB7IC8vdmVyemVuZGVuIGJlcmljaHRcclxuICAgICAgICAgICAgdmFyIGlucHV0dGV4dCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwiaW5wdXRUZXh0Q2hhdFwiKTtcclxuICAgICAgICAgICAgaWYgKGlucHV0dGV4dC52YWx1ZSAhPT0gXCJcIikge1xyXG4gICAgICAgICAgICAgICAgcHJvZmlsZVNlcnZpY2UuZ2V0VXNlcihmdW5jdGlvbiAoZXJyLCB1c2VyRGF0YSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICghZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh1c2VyRGF0YS5yZWRpcmVjdCkgeyAvL3VzZXIgaXMgbm9nIG5pZXQgaW5nZWxvZ2QgYmlqIGhldCBjaGF0dGVuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaGFyZVZhcnNCZXR3ZWVuQ3RybC5zZXRFeHRyYUxvZ2luSW5mbyhcIllvdSBuZWVkIHRvIGJlIGxvZ2dlZCBpbiB0byBjaGF0LlwiKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICRsb2NhdGlvbi5wYXRoKHVzZXJEYXRhLnJlZGlyZWN0KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbWVzc2FnZU9iaiA9IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXh0OiBpbnB1dHRleHQudmFsdWUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VuZGVyOiB1c2VyRGF0YS5pZCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWNlaXZlcjogJHJvdXRlUGFyYW1zLnBhcmFtLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbmRlclVzZXJuYW1lOiB1c2VyRGF0YS51c2VybmFtZVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNvY2tldC5lbWl0KFwiY2hhdE1lc3NhZ2VcIiwgbWVzc2FnZU9iaik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkc2NvcGUuY2hhdE1lc3NhZ2VzLnB1c2goe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRleHQ6IGlucHV0dGV4dC52YWx1ZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZW5kZXI6IHVzZXJEYXRhLnVzZXJuYW1lLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNzc0NsYXNzOiBcIm1lXCJcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOyAvL3B1c2hlbiBuYWFyIHNjb3BlIG9tIGNoYXRidWJibGUgdGUgdG9uZW5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlucHV0dGV4dC52YWx1ZSA9IFwiXCI7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcImVycm9yIHdoaWxlIGdldHRpbmcgdXNlcjogXCIgKyBlcnIpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgLy9jaGF0IGVpbmRlXHJcblxyXG4gICAgICAgIHNoYXJlU2VydmljZS5nZXRBbGxTaGFyZXMoZnVuY3Rpb24gKGVyciwgc2hhcmVzKSB7XHJcbiAgICAgICAgICAgIGlmICghZXJyKSB7XHJcbiAgICAgICAgICAgICAgICBnb29nbGVNYXBzU2VydmljZS5zaG93TG9jYXRpb25Pbk1hcCgpO1xyXG4gICAgICAgICAgICAgICAgJHNjb3BlLnNoYXJlcyA9IHNoYXJlcztcclxuICAgICAgICAgICAgICAgICRzY29wZS50aW1lbGFwc2UgPSAwO1xyXG4gICAgICAgICAgICAgICAgJHNjb3BlLnRpbWVzdGFtcCA9IFwibGFzdCBob3VyXCI7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgU2hhcmVTZXJ2aWNlRXhjZXB0aW9uKGVycik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgJHNjb3BlLiR3YXRjaChcInRpbWVsYXBzZVwiLCBmdW5jdGlvbigpIHtcclxuICAgICAgICAgICAgaWYoJHNjb3BlLnRpbWVsYXBzZSA9PSAxMDApIHtcclxuICAgICAgICAgICAgICAgICRzY29wZS50aW1lc3RhbXAgPSBcIkFsbCB0aW1lXCI7XHJcbiAgICAgICAgICAgICAgICBnb29nbGVNYXBzU2VydmljZS5yZW1vdmVNYXJrZXJzKCk7XHJcbiAgICAgICAgICAgICAgICBnb29nbGVNYXBzU2VydmljZS5zaG93QWxsTWFya2VycyhmaWx0ZXJTaGFyZXNPblRpbWUoXCJhbGxcIikpO1xyXG4gICAgICAgICAgICB9IGVsc2UgaWYoJHNjb3BlLnRpbWVsYXBzZSA9PSA4MCkge1xyXG4gICAgICAgICAgICAgICAgJHNjb3BlLnRpbWVzdGFtcCA9IFwiTGFzdCB5ZWFyXCI7XHJcbiAgICAgICAgICAgICAgICBnb29nbGVNYXBzU2VydmljZS5yZW1vdmVNYXJrZXJzKCk7XHJcbiAgICAgICAgICAgICAgICBnb29nbGVNYXBzU2VydmljZS5zaG93QWxsTWFya2VycyhmaWx0ZXJTaGFyZXNPblRpbWUoXCJ5ZWFyXCIpKTtcclxuICAgICAgICAgICAgfSBlbHNlIGlmKCRzY29wZS50aW1lbGFwc2UgPT0gNjApIHtcclxuICAgICAgICAgICAgICAgICRzY29wZS50aW1lc3RhbXAgPSBcIkxhc3QgbW9udGhcIjtcclxuICAgICAgICAgICAgICAgIGdvb2dsZU1hcHNTZXJ2aWNlLnJlbW92ZU1hcmtlcnMoKTtcclxuICAgICAgICAgICAgICAgIGdvb2dsZU1hcHNTZXJ2aWNlLnNob3dBbGxNYXJrZXJzKGZpbHRlclNoYXJlc09uVGltZShcIm1vbnRoXCIpKTtcclxuICAgICAgICAgICAgfSBlbHNlIGlmKCRzY29wZS50aW1lbGFwc2UgPT0gNDApIHtcclxuICAgICAgICAgICAgICAgICRzY29wZS50aW1lc3RhbXAgPSBcIkxhc3Qgd2Vla1wiO1xyXG4gICAgICAgICAgICAgICAgZ29vZ2xlTWFwc1NlcnZpY2UucmVtb3ZlTWFya2VycygpO1xyXG4gICAgICAgICAgICAgICAgZ29vZ2xlTWFwc1NlcnZpY2Uuc2hvd0FsbE1hcmtlcnMoZmlsdGVyU2hhcmVzT25UaW1lKFwid2Vla1wiKSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZigkc2NvcGUudGltZWxhcHNlID09IDIwKSB7XHJcbiAgICAgICAgICAgICAgICAkc2NvcGUudGltZXN0YW1wID0gXCJMYXN0IGRheVwiO1xyXG4gICAgICAgICAgICAgICAgZ29vZ2xlTWFwc1NlcnZpY2UucmVtb3ZlTWFya2VycygpO1xyXG4gICAgICAgICAgICAgICAgZ29vZ2xlTWFwc1NlcnZpY2Uuc2hvd0FsbE1hcmtlcnMoZmlsdGVyU2hhcmVzT25UaW1lKFwiZGF5XCIpKTtcclxuICAgICAgICAgICAgfSBlbHNlIGlmKCRzY29wZS50aW1lbGFwc2UgPT09IDApIHtcclxuICAgICAgICAgICAgICAgICRzY29wZS50aW1lc3RhbXAgPSBcImxhc3QgaG91clwiO1xyXG4gICAgICAgICAgICAgICAgZ29vZ2xlTWFwc1NlcnZpY2UucmVtb3ZlTWFya2VycygpO1xyXG4gICAgICAgICAgICAgICAgZ29vZ2xlTWFwc1NlcnZpY2Uuc2hvd0FsbE1hcmtlcnMoZmlsdGVyU2hhcmVzT25UaW1lKFwiaG91clwiKSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgdmFyIGZpbHRlclNoYXJlc09uVGltZSA9IGZ1bmN0aW9uKHRpbWUpIHtcclxuICAgICAgICAgICAgdmFyIHNoYXJlcyA9IFtdO1xyXG5cclxuICAgICAgICAgICAgc3dpdGNoICh0aW1lKSB7XHJcbiAgICAgICAgICAgICAgICBjYXNlIFwiYWxsXCI6XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRzY29wZS5zaGFyZXM7XHJcbiAgICAgICAgICAgICAgICBjYXNlIFwieWVhclwiOlxyXG4gICAgICAgICAgICAgICAgICAgIGFuZ3VsYXIuZm9yRWFjaCgkc2NvcGUuc2hhcmVzLCBmdW5jdGlvbihzaGFyZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhuZXcgRGF0ZSgpLmdldFllYXIoKSAtIG5ldyBEYXRlKHNoYXJlLnRpbWUpLmdldFllYXIoKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKChuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIG5ldyBEYXRlKHNoYXJlLnRpbWUpLmdldFRpbWUoKSkgPD0gKCgzNjAwMDAgKiAyNCkgKiAzNjUpKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2hhcmVzLnB1c2goc2hhcmUpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBzaGFyZXM7XHJcbiAgICAgICAgICAgICAgICBjYXNlIFwibW9udGhcIjpcclxuICAgICAgICAgICAgICAgICAgICBhbmd1bGFyLmZvckVhY2goJHNjb3BlLnNoYXJlcywgZnVuY3Rpb24oc2hhcmUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYoKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gbmV3IERhdGUoc2hhcmUudGltZSkuZ2V0VGltZSgpKSA8PSAoKDM2MDAwMCAqIDI0KSAqIDMxKSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNoYXJlcy5wdXNoKHNoYXJlKTtcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gc2hhcmVzO1xyXG4gICAgICAgICAgICAgICAgY2FzZSBcIndlZWtcIjpcclxuICAgICAgICAgICAgICAgICAgICBhbmd1bGFyLmZvckVhY2goJHNjb3BlLnNoYXJlcywgZnVuY3Rpb24oc2hhcmUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYoKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gbmV3IERhdGUoc2hhcmUudGltZSkuZ2V0VGltZSgpKSA8PSAoKDM2MDAwMCAqIDI0KSAqIDcpKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2hhcmVzLnB1c2goc2hhcmUpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBzaGFyZXM7XHJcbiAgICAgICAgICAgICAgICBjYXNlIFwiZGF5XCI6XHJcbiAgICAgICAgICAgICAgICAgICAgYW5ndWxhci5mb3JFYWNoKCRzY29wZS5zaGFyZXMsIGZ1bmN0aW9uKHNoYXJlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKChuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIG5ldyBEYXRlKHNoYXJlLnRpbWUpLmdldFRpbWUoKSkgPD0gKDM2MDAwMCAqIDI0KSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNoYXJlcy5wdXNoKHNoYXJlKTtcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gc2hhcmVzO1xyXG4gICAgICAgICAgICAgICAgY2FzZSBcImhvdXJcIjpcclxuICAgICAgICAgICAgICAgICAgICBhbmd1bGFyLmZvckVhY2goJHNjb3BlLnNoYXJlcywgZnVuY3Rpb24oc2hhcmUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYoKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gbmV3IERhdGUoc2hhcmUudGltZSkuZ2V0VGltZSgpKSA8PSAzNjAwMDApXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaGFyZXMucHVzaChzaGFyZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNoYXJlcztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcbiAgICB9O1xyXG4gICAgYW5ndWxhci5tb2R1bGUoXCJnZW9mZWVsaW5nc1wiKS5jb250cm9sbGVyKFwibWFpbkNvbnRyb2xsZXJcIiwgW1wiJHNjb3BlXCIsIFwiZ29vZ2xlTWFwc1NlcnZpY2VcIiwgXCJzaGFyZVNlcnZpY2VcIiwgXCJwcm9maWxlU2VydmljZVwiLCBcIiRsb2NhdGlvblwiLCBcIiRyb3V0ZVBhcmFtc1wiLCBtYWluQ29udHJvbGxlcl0pO1xyXG59KSgpOyIsIi8qKlxyXG4gKiBDcmVhdGVkIGJ5IEpvbmF0YW4gb24gMjUvMTEvMjAxNS5cclxuICovXHJcblxyXG5cclxuKGZ1bmN0aW9uICgpIHtcclxuICAgIFwidXNlIHN0cmljdFwiO1xyXG5cclxuICAgIHZhciBzZWFyY2hDb250cm9sbGVyID0gZnVuY3Rpb24gKCRzY29wZSwgdXNlclNlcnZpY2UsIGV2ZW50U2VydmljZSxwcm9maWxlU2VydmljZSxzaGFyZVZhcnNCZXR3ZWVuQ3RybCwkbG9jYXRpb24pIHtcclxuXHJcbiAgICAgICAgJHNjb3BlLnNlYXJjaE1vZGVsID0gbnVsbDtcclxuXHJcbiAgICAgICAgJHNjb3BlLnNlYXJjaE9uU3VibWl0ID0gZnVuY3Rpb24gKGZvcm1PYmopIHtcclxuICAgICAgICAgICAgaWYgKCRzY29wZS5zZWFyY2hNb2RlbC5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgICAgICBzZWFyY2hOb3coKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcbiAgICAgICAgJHNjb3BlLnNlYXJjaE9uS2V5UHJlc3MgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIGlmICgkc2NvcGUuc2VhcmNoTW9kZWwgIT09IG51bGwpIHtcclxuICAgICAgICAgICAgICAgIHNlYXJjaE5vdygpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgJHNjb3BlLmZpbHRlclNlYXJjaFJlc3VsdHMgPSBmdW5jdGlvbiAoaSkge1xyXG4gICAgICAgICAgICBpZiAoJHNjb3BlLnNlYXJjaE1vZGVsID09PSBcIlwiKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmIChpLnRpdGxlLnRvTG93ZXJDYXNlKCkuaW5kZXhPZigkc2NvcGUuc2VhcmNoTW9kZWwudG9Mb2NhbGVMb3dlckNhc2UoKSkgPj0gMCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKGkuc3VidGl0bGUgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgaWYgKGkuc3VidGl0bGUudG9Mb3dlckNhc2UoKS5pbmRleE9mKCRzY29wZS5zZWFyY2hNb2RlbC50b0xvY2FsZUxvd2VyQ2FzZSgpKSA+PSAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICB2YXIgc2VhcmNoTm93ID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAkc2NvcGUubWF4UmVzRXhjZWVkZWQgPSBmYWxzZTtcclxuXHJcbiAgICAgICAgICAgIHByb2ZpbGVTZXJ2aWNlLmdldFVzZXIoZnVuY3Rpb24gKGVyciwgdXNlckRhdGEpIHtcclxuICAgICAgICAgICAgICAgIGlmICghZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHVzZXJEYXRhLnJlZGlyZWN0KSB7IC8vdXNlciBpcyBub2cgbmlldCBpbmdlbG9nZCBiaWogaGV0IHNoYXJlblxyXG4gICAgICAgICAgICAgICAgICAgICAgICBzaGFyZVZhcnNCZXR3ZWVuQ3RybC5zZXRFeHRyYUxvZ2luSW5mbyhcIllvdSBuZWVkIHRvIGxvZ2luIGJlZm9yZSB1c2luZyB0aGUgc2VhcmNoIGZ1bnRpb24uXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAkbG9jYXRpb24ucGF0aCh1c2VyRGF0YS5yZWRpcmVjdCk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHVzZXJTZXJ2aWNlLmdldEFsbFVzZXJzKGZ1bmN0aW9uIChlcnIsIHJlc3VsdHMpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcImVycm9yOlwiICsgZXJyKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB2aXNpYmxlcmVzID0gW107XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGkgPSAwLCBtYXggPSA1O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFuZ3VsYXIuZm9yRWFjaChyZXN1bHRzLCBmdW5jdGlvbiAocmVzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpIDwgbWF4KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2aXNpYmxlcmVzLnB1c2gocmVzKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGkrKztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZS5zZWFyY2hSZXN1bHRzVXNlcnMgPSB2aXNpYmxlcmVzO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50U2VydmljZS5nZXRBbGxFdmVudHMoZnVuY3Rpb24gKGVyciwgcmVzdWx0cykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiZXJyb3I6XCIgKyBlcnIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHZpc2libGVyZXMgPSBbXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgaSA9IDAsIG1heCA9IDU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYW5ndWxhci5mb3JFYWNoKHJlc3VsdHMsIGZ1bmN0aW9uIChyZXMpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGkgPCBtYXgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZpc2libGVyZXMucHVzaChyZXMpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaSsrO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHNjb3BlLnNlYXJjaFJlc3VsdHNFdmVudHMgPSB2aXNpYmxlcmVzO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiZXJyb3Igd2hpbGUgZ2V0dGluZyB1c2VyOiBcIiArIGVycik7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcbiAgICB9O1xyXG5cclxuICAgIGFuZ3VsYXIubW9kdWxlKFwiZ2VvZmVlbGluZ3NcIikuY29udHJvbGxlcihcInNlYXJjaENvbnRyb2xsZXJcIiwgW1wiJHNjb3BlXCIsIFwidXNlclNlcnZpY2VcIiwgXCJldmVudFNlcnZpY2VcIixcInByb2ZpbGVTZXJ2aWNlXCIsXCJzaGFyZVZhcnNCZXR3ZWVuQ3RybFwiLFwiJGxvY2F0aW9uXCIsIHNlYXJjaENvbnRyb2xsZXJdKTtcclxufSkoKTsiLCIvKipcclxuICogQ3JlYXRlZCBieSBKb25hdGFuIG9uIDIxLzEyLzIwMTUuXHJcbiAqL1xyXG5cclxuKGZ1bmN0aW9uICgpIHtcclxuICAgIFwidXNlIHN0cmljdFwiO1xyXG5cclxuICAgIHZhciBzb2NrZXQgPSBpby5jb25uZWN0KFwiaHR0cDovL2xvY2FsaG9zdDozMDAxXCIpO1xyXG5cclxuICAgIHZhciBtZUNvbnRyb2xsZXIgPSBmdW5jdGlvbiAoJHNjb3BlLCAkaHR0cCwgJGxvY2F0aW9uLCAkc2NlLCBwcm9maWxlU2VydmljZSwgc2hhcmVTZXJ2aWNlKSB7XHJcbiAgICAgICAgcHJvZmlsZVNlcnZpY2UuZ2V0VXNlcihmdW5jdGlvbiAoZXJyLCB1c2VyKSB7XHJcbiAgICAgICAgICAgIGlmICghZXJyKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAodXNlci5yZWRpcmVjdCkge1xyXG4gICAgICAgICAgICAgICAgICAgICRsb2NhdGlvbi5wYXRoKHVzZXIucmVkaXJlY3QpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAkc2NvcGUudXNlciA9IHVzZXI7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYodXNlci5hZGRyZXNzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZS51c2VyLmFkZHJlc3MxID0gc3BsaXRBZGRyZXNzKHVzZXIuYWRkcmVzcywgMCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZS51c2VyLmFkZHJlc3MyID0gc3BsaXRBZGRyZXNzKHVzZXIuYWRkcmVzcywgMSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICBpZighdXNlci5hZ2UpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgJHNjb3BlLnVzZXIuYWdlID0gbmV3IERhdGUoKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIHNoYXJlU2VydmljZS5nZXRTaGFyZXNCeVVzZXJJZCh1c2VyLmlkLCBmdW5jdGlvbiAoZXJyLCBzaGFyZXMpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYoIWVycikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoc2hhcmVzLnJlZGlyZWN0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGxvY2F0aW9uLnBhdGgoc2hhcmVzLnJlZGlyZWN0KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoc2hhcmVzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHNjb3BlLnNoYXJlc2ZvcnByb2ZpbGUgPSBzaGFyZXM7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHNjb3BlLm5vU2hhcmVzRm9yVXNlciA9IFwiPGRpdj5Zb3UgaGF2ZSBubyBzaGFyZXMgeWV0LCBnbyBzaGFyZSBvbmUgPGEgaHJlZj0nIy9pbnRybyc+aGVyZTwvYT48L2Rpdj5cIjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgU2hhcmVTZXJ2aWNlRXhjZXB0aW9uKGVycik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBQcm9maWxlU2VydmljZUV4Y2VwdGlvbihlcnIpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICRzY29wZS5zYXZlID0gZnVuY3Rpb24gKHVzZXIpIHtcclxuICAgICAgICAgICAgdXNlci5hZGRyZXNzID0gbWFrZUFkZHJlc3ModXNlci5hZGRyZXNzMSwgdXNlci5hZGRyZXNzMik7XHJcbiAgICAgICAgICAgIHByb2ZpbGVTZXJ2aWNlLnNhdmVVc2VyKHVzZXIsIGZ1bmN0aW9uKGVyciwgZGF0YSkge1xyXG4gICAgICAgICAgICAgICAgaWYoIWVycikge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChkYXRhLnJlZGlyZWN0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICRsb2NhdGlvbi5wYXRoKGRhdGEucmVkaXJlY3QpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZihkYXRhLmVycm9yKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZS5lcnJvck1lID0gZGF0YS5lcnJvcjtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAkc2NvcGUudXNlciA9IGRhdGE7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZS51c2VyLmFkZHJlc3MxID0gc3BsaXRBZGRyZXNzKGRhdGEuYWRkcmVzcywgMCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZS51c2VyLmFkZHJlc3MyID0gc3BsaXRBZGRyZXNzKGRhdGEuYWRkcmVzcywgMSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBpZihlcnIgPT09IFwiWkVST19SRVNVTFRTXCIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgJHNjb3BlLmVycm9yTWUgPSBcIk5vIGFkZHJlc3MgZm91bmQhIFN0cmVldCAmIE51bWJlciBhbmQgWmlwICYgQ2l0eSBhcmUgcmVxdWlyZWQhIE1ha2Ugc3VyZSB0aGVyIGlzIGEgc3BhY2UgYmV0d2VlbiB5b3VyIGlucHV0IGFuZCBubyBrb21tYSgsKVwiO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZS5lcnJvck1lID0gXCJTb21ldGhpbmcgd2VudCB3cm9uZywgdHJ5IGFnYWluIGxhdGVyIVwiO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgJHNjb3BlLmxvZ291dCA9IGZ1bmN0aW9uICgpIHtcclxuXHJcblxyXG4gICAgICAgICAgICBwcm9maWxlU2VydmljZS5nZXRVc2VyKGZ1bmN0aW9uIChlcnIsIHVzZXJEYXRhKSB7IC8vemVuZCBqZSBpZCBuYWFyIGRlIHNlcnZlciBvbSB0ZSB6ZWdnZW4gZGF0IGplIHdlZ2dhYXQgZW4gbmlldCBtZWVyIHdpbHQgY2hhdHRlblxyXG4gICAgICAgICAgICAgICAgaWYgKCFlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAodXNlckRhdGEucmVkaXJlY3QpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy91c2VyaWQgbmlldCBsb2dnZWQgaW4sIG5vZyB0b2V2b2VnZW4gZGF0IGhpaiB6ZW4gaWQgc3R1dXJ0IGJpaiBpbmxvZ2dlbiFcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzb2NrZXQuZW1pdChcImxvZ291dE1lc3NhZ2VcIiwgdXNlckRhdGEuaWQpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJlcnJvciB3aGlsZSBnZXR0aW5nIHVzZXJpZDogXCIgKyBlcnIpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIHByb2ZpbGVTZXJ2aWNlLmxvZ291dCgpLnRoZW4oZnVuY3Rpb24gKGRhdGEpIHtcclxuICAgICAgICAgICAgICAgICRsb2NhdGlvbi5wYXRoKGRhdGEpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICAkc2NvcGUucmVuZGVySHRtbCA9IGZ1bmN0aW9uKGh0bWwpIHtcclxuICAgICAgICAgICAgcmV0dXJuICRzY2UudHJ1c3RBc0h0bWwoaHRtbCk7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgJHNjb3BlLmdldFNoYXJlSW5mbyA9IGZ1bmN0aW9uKHNoYXJlKSB7XHJcbiAgICAgICAgICAgIGlmKHNoYXJlLmV2ZW50KSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gc2hhcmUuZXZlbnQuZXZlbnRuYW1lO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHNoYXJlLmFkZHJlc3M7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICAkc2NvcGUuZ2V0U2hhcmVJbWFnZSA9IGZ1bmN0aW9uKHNoYXJlKSB7XHJcbiAgICAgICAgICAgIGlmKHNoYXJlLmV2ZW50KSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gc2hhcmUuZXZlbnQuZXZlbnRpbWFnZTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBcImh0dHA6Ly9zdHVkZW50Lmhvd2VzdC5iZS9qb25hdGFuLm1pY2hpZWxzL2dlb2ZlZWxpbmdzL2Fzc2V0cy9sb2NhdGlvbi5wbmdcIjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHZhciBzcGxpdEFkZHJlc3MgPSBmdW5jdGlvbiAoYWRkcmVzcywgcGFydCkge1xyXG4gICAgICAgICAgICB2YXIgc3BsaXQgPSBhZGRyZXNzLnNwbGl0KFwiLFwiKTtcclxuICAgICAgICAgICAgcmV0dXJuIHNwbGl0W3BhcnRdO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHZhciBtYWtlQWRkcmVzcyA9IGZ1bmN0aW9uIChhZGRyZXNzMSwgYWRkcmVzczIpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGFkZHJlc3MxICsgXCIsXCIgKyBhZGRyZXNzMjtcclxuICAgICAgICB9O1xyXG4gICAgfTtcclxuXHJcbiAgICBhbmd1bGFyLm1vZHVsZShcImdlb2ZlZWxpbmdzXCIpLmNvbnRyb2xsZXIoXCJtZUNvbnRyb2xsZXJcIiwgW1wiJHNjb3BlXCIsIFwiJGh0dHBcIiwgXCIkbG9jYXRpb25cIiwgXCIkc2NlXCIsIFwicHJvZmlsZVNlcnZpY2VcIiwgXCJzaGFyZVNlcnZpY2VcIiwgbWVDb250cm9sbGVyXSk7XHJcbn0pKCk7IiwiLyoqXHJcbiAqIENyZWF0ZWQgYnkgSm9uYXRhbiBvbiAxLzEyLzIwMTUuXHJcbiAqL1xyXG5cclxuKGZ1bmN0aW9uICgpIHtcclxuICAgIFwidXNlIHN0cmljdFwiO1xyXG5cclxuICAgIHZhciB1c2VyQ29udHJvbGxlciA9IGZ1bmN0aW9uICgkc2NvcGUsICRsb2NhdGlvbiwgdXNlclNlcnZpY2UsIHNoYXJlU2VydmljZSwgJHJvdXRlUGFyYW1zKSB7XHJcblxyXG4gICAgICAgICRzY29wZS5pbml0ID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICB2YXIgdXNlcmlkID0gJHJvdXRlUGFyYW1zLnBhcmFtO1xyXG4gICAgICAgICAgICB1c2VyU2VydmljZS5zZWFyY2hVc2VyRnJvbUlkKHVzZXJpZCkudGhlbih1c2VyRm91bmRXaXRoSWQpO1xyXG5cclxuICAgICAgICAgICAgc2hhcmVTZXJ2aWNlLmdldFNoYXJlc0J5VXNlcklkKHVzZXJpZCwgZnVuY3Rpb24gKGVyciwgc2hhcmVzKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoIWVycikge1xyXG4gICAgICAgICAgICAgICAgICAgICRzY29wZS5zaGFyZUZvdW5kV2l0aFVzZXJJZCA9IHNoYXJlcztcclxuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygkc2NvcGUuc2hhcmVGb3VuZFdpdGhVc2VySWQpO1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBmZWVsaW5nSW1hZ2VzID0gW1wiZGVwcmVzc2VkXCIsIFwic2FkXCIsIFwiY29tbW9uXCIsIFwiaGFwcHlcIiwgXCJleGNpdGVkXCJdO1xyXG4gICAgICAgICAgICAgICAgICAgIGFuZ3VsYXIuZm9yRWFjaChzaGFyZXMsIGZ1bmN0aW9uIChzaGFyZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzaGFyZS5tb29kSW1hZ2VTb3VyY2UgPSBcIi4vYXNzZXRzL1wiICsgZmVlbGluZ0ltYWdlc1tnaXZlRmVlbGluZ3NJbWFnZUFycmF5TnVtYmVyKHNoYXJlKV0gKyBcIi5wbmdcIjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgJHNjb3BlLm1hcmtlciA9IG5ldyBnb29nbGUubWFwcy5NYXJrZXIoe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zaXRpb246IHtsYXQ6IHNoYXJlLmxhdCwgbG5nOiBzaGFyZS5sbmd9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFwOiAkc2NvcGUubWFwLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWNvbjogc2hhcmUubW9vZEltYWdlU291cmNlXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIj4gZXJyb3IgaW4gc2hhcmVTZXJ2aWNlOiBcIiArIGVycik7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHZhciB1c2VyRm91bmRXaXRoSWQgPSBmdW5jdGlvbiAocmVzKSB7XHJcbiAgICAgICAgICAgICRzY29wZS51c2VyZm91bmR3aXRoaWQgPSByZXM7XHJcblxyXG4gICAgICAgICAgICBpZiAocmVzLmxhdCAhPT0gdW5kZWZpbmVkICYmIHJlcy5sYXQgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgJHNjb3BlLm1hcC5zZXRDZW50ZXIobmV3IGdvb2dsZS5tYXBzLkxhdExuZyhyZXMubGF0LCByZXMubG5nKSk7XHJcbiAgICAgICAgICAgICAgICBpZiAoJHNjb3BlLm1hcmtlciAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgJHNjb3BlLm1hcmtlci5zZXRNYXAobnVsbCk7IC8vdmVyd2lqZGVydCBhbGxlIG1hcmtlcnMgZWVyc3RcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICRzY29wZS5tYXJrZXIgPSBuZXcgZ29vZ2xlLm1hcHMuTWFya2VyKHtcclxuICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbjoge2xhdDogcmVzLmxhdCwgbG5nOiByZXMubG5nfSxcclxuICAgICAgICAgICAgICAgICAgICBtYXA6ICRzY29wZS5tYXAsXHJcbiAgICAgICAgICAgICAgICAgICAgaWNvbjogJHNjb3BlLmltYWdlXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHZhciBnaXZlRmVlbGluZ3NJbWFnZUFycmF5TnVtYmVyID0gZnVuY3Rpb24gKHNoYXJlKSB7XHJcbiAgICAgICAgICAgIGlmIChzaGFyZS5tb29kID4gODApIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiA0O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIE1hdGgucm91bmQoc2hhcmUubW9vZCAvIDIwKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcbiAgICB9O1xyXG5cclxuICAgIGFuZ3VsYXIubW9kdWxlKFwiZ2VvZmVlbGluZ3NcIikuY29udHJvbGxlcihcInVzZXJDb250cm9sbGVyXCIsIFtcIiRzY29wZVwiLCBcIiRsb2NhdGlvblwiLCBcInVzZXJTZXJ2aWNlXCIsIFwic2hhcmVTZXJ2aWNlXCIsIFwiJHJvdXRlUGFyYW1zXCIsIHVzZXJDb250cm9sbGVyXSk7XHJcbn0pXHJcbigpOyIsIi8qKlxyXG4gKiBDcmVhdGVkIGJ5IEpvbmF0YW4gb24gMjgvMTIvMjAxNS5cclxuICovXHJcblxyXG52YXIgZXZlbnRTZXJ2aWNlID0gZnVuY3Rpb24gKCRodHRwLCBnb29nbGVNYXBzU2VydmljZSkge1xyXG4gICAgXCJ1c2Ugc3RyaWN0XCI7XHJcblxyXG4gICAgLy9wcml2YXRlXHJcblxyXG4gICAgLy9wdWJsaWNcclxuICAgIHJldHVybiB7XHJcblxyXG4gICAgICAgIGdldEFsbEV2ZW50czogZnVuY3Rpb24gKGNiKSB7XHJcbiAgICAgICAgICAgICRodHRwLmdldChcIi9hcGkvZXZlbnRcIikuc3VjY2VzcyhmdW5jdGlvbiAoZGF0YSkge1xyXG4gICAgICAgICAgICAgICAgaWYgKGRhdGEucmVkaXJlY3QpIHtcclxuICAgICAgICAgICAgICAgICAgICBjYihudWxsLCBkYXRhKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIHZhciBldmVudHNGb3VuZCA9IFtdO1xyXG4gICAgICAgICAgICAgICAgICAgIGFuZ3VsYXIuZm9yRWFjaChkYXRhLCBmdW5jdGlvbiAoc2VhcmNoUikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgbmV3U1IgPSBuZXcgU2VhcmNoUmVzdWx0KHNlYXJjaFIuZXZlbnRuYW1lLCBzZWFyY2hSLmFkZHJlc3MsIHNlYXJjaFIuX2lkLFwiZXZlbnRcIik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50c0ZvdW5kLnB1c2gobmV3U1IpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIGNiKG51bGwsIGV2ZW50c0ZvdW5kKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSkuZXJyb3IoZnVuY3Rpb24gKGVycm9yKSB7XHJcbiAgICAgICAgICAgICAgICBjYihlcnJvciwgbnVsbCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0sXHJcblxyXG4gICAgICAgIGdldEV2ZW50czogZnVuY3Rpb24gKGNiKSB7XHJcbiAgICAgICAgICAgICRodHRwLmdldChcIi9hcGkvZXZlbnRcIikuc3VjY2VzcyhmdW5jdGlvbiAoZGF0YSkge1xyXG4gICAgICAgICAgICAgICAgaWYoZGF0YS5yZWRpcmVjdCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNiKG51bGwsIGRhdGEpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgZXZlbnRzID0gW107XHJcbiAgICAgICAgICAgICAgICAgICAgYW5ndWxhci5mb3JFYWNoKGRhdGEsIGZ1bmN0aW9uKGV2ZW50KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50cy5wdXNoKG5ldyBHZkV2ZW50KGV2ZW50Ll9pZCwgZXZlbnQuZXZlbnRuYW1lLCBldmVudC5ldmVudGltYWdlLCBldmVudC5hdXRob3JpZCwgZXZlbnQuZnJvbSwgZXZlbnQudW50aWwsIGV2ZW50LmxhdCwgZXZlbnQubG5nLCBldmVudC5hZGRyZXNzKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgY2IobnVsbCwgZXZlbnRzKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSkuZXJyb3IoZnVuY3Rpb24gKGVycm9yKSB7XHJcbiAgICAgICAgICAgICAgICBjYihlcnJvciwgbnVsbCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0sXHJcblxyXG4gICAgICAgIGdldEV2ZW50QnlJZDogZnVuY3Rpb24gKGV2ZW50aWQsIGNiKSB7XHJcbiAgICAgICAgICAgICRodHRwLmdldChcIi9hcGkvZXZlbnQvXCIgKyBldmVudGlkKS5zdWNjZXNzKGZ1bmN0aW9uIChkYXRhKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZGF0YS5yZWRpcmVjdCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNiKG51bGwsIGRhdGEpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZGF0YS5hZGRyZXNzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNiKG51bGwsIG5ldyBHZkV2ZW50KGRhdGEuX2lkLCBkYXRhLmV2ZW50bmFtZSwgZGF0YS5ldmVudGltYWdlLCBkYXRhLmF1dGhvcmlkLCBuZXcgRGF0ZShkYXRhLmZyb20pLCBuZXcgRGF0ZShkYXRhLnVudGlsKSwgZGF0YS5sYXQsIGRhdGEubG5nLCBkYXRhLmFkZHJlc3MpKTtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBnb29nbGVNYXBzU2VydmljZS5jb252ZXJ0Q29vcmRpbmF0ZXNUb0FkcmVzcyhkYXRhLmxhdCwgZGF0YS5sbmcsIGZ1bmN0aW9uIChlcnIsIGFkZHJlc3MpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2IobnVsbCwgY2IobnVsbCwgbmV3IEdmRXZlbnQoZGF0YS5faWQsIGRhdGEuZXZlbnRuYW1lLCBkYXRhLmV2ZW50aW1hZ2UsIGRhdGEuYXV0aG9yaWQsIG5ldyBEYXRlKGRhdGEuZnJvbSksIG5ldyBEYXRlKGRhdGEudW50aWwpLCBkYXRhLmxhdCwgZGF0YS5sbmcsIGFkZHJlc3MpKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNiKGVyciwgbnVsbCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSkuZXJyb3IoZnVuY3Rpb24gKGVycm9yKSB7XHJcbiAgICAgICAgICAgICAgICBjYihlcnJvciwgbnVsbCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0sXHJcblxyXG4gICAgICAgIGdldEV2ZW50QnlJZEZvclNoYXJlOiBmdW5jdGlvbiAoZXZlbnRpZCwgY2IpIHtcclxuICAgICAgICAgICAgJGh0dHAuZ2V0KFwiL2FwaS9ldmVudC9cIiArIGV2ZW50aWQpLnN1Y2Nlc3MoZnVuY3Rpb24oZGF0YSkge1xyXG4gICAgICAgICAgICAgICAgY2IobnVsbCwgbmV3IEdmRXZlbnQoZGF0YS5faWQsIGRhdGEuZXZlbnRuYW1lLCBkYXRhLmV2ZW50aW1hZ2UsIG51bGwsIG51bGwsIG51bGwsIG51bGwsIG51bGwsIG51bGwpKTtcclxuICAgICAgICAgICAgfSkuZXJyb3IoZnVuY3Rpb24gKGVycm9yKSB7XHJcbiAgICAgICAgICAgICAgICBjYihlcnJvciwgbnVsbCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0sXHJcblxyXG4gICAgICAgIHBvc3RFdmVudDogZnVuY3Rpb24gKGRhdGEsIGNiKSB7XHJcbiAgICAgICAgICAgIGdvb2dsZU1hcHNTZXJ2aWNlLmNvbnZlcnRBZHJlc3NUb0Nvb3JkaW5hdGVzKGRhdGEuYWRkcmVzcywgZnVuY3Rpb24gKGVyciwgY29vcmQpIHtcclxuICAgICAgICAgICAgICAgIGlmICghZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZGF0YS5sYXQgPSBjb29yZC5sYXQoKTtcclxuICAgICAgICAgICAgICAgICAgICBkYXRhLmxuZyA9IGNvb3JkLmxuZygpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAkaHR0cC5wb3N0KFwiL2FwaS9ldmVudFwiLCBuZXcgR2ZFdmVudChkYXRhLl9pZCwgZGF0YS5ldmVudG5hbWUsIGRhdGEuZXZlbnRpbWFnZSwgZGF0YS5hdXRob3JpZCwgbmV3IERhdGUoZGF0YS5mcm9tKSwgbmV3IERhdGUoZGF0YS51bnRpbCksIGRhdGEubGF0LCBkYXRhLmxuZywgZGF0YS5hZGRyZXNzKSkuc3VjY2VzcyhmdW5jdGlvbiAocmVzcG9uc2UpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2IobnVsbCwgcmVzcG9uc2UpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pLmVycm9yKGZ1bmN0aW9uIChlcnJvcikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjYihlcnJvciwgbnVsbCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGNiKGVyciwgbnVsbCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0sXHJcblxyXG4gICAgICAgIHVwZGF0ZUV2ZW50OiBmdW5jdGlvbiAoZGF0YSwgY2IpIHtcclxuICAgICAgICAgICAgZ29vZ2xlTWFwc1NlcnZpY2UuY29udmVydEFkcmVzc1RvQ29vcmRpbmF0ZXMoZGF0YS5hZGRyZXNzLCBmdW5jdGlvbiAoZXJyLCBjb29yZCkge1xyXG4gICAgICAgICAgICAgICAgaWYgKCFlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICBkYXRhLmxhdCA9IGNvb3JkLmxhdCgpO1xyXG4gICAgICAgICAgICAgICAgICAgIGRhdGEubG5nID0gY29vcmQubG5nKCk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICRodHRwLnB1dChcIi9hcGkvZXZlbnQvXCIgKyBkYXRhLmlkLCBkYXRhKS5zdWNjZXNzKGZ1bmN0aW9uIChyZXNwb25zZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjYihudWxsLCBuZXcgR2ZFdmVudChyZXNwb25zZS5faWQsIHJlc3BvbnNlLmV2ZW50bmFtZSwgcmVzcG9uc2UuZXZlbnRpbWFnZSwgcmVzcG9uc2UuYXV0aG9yaWQsIG5ldyBEYXRlKHJlc3BvbnNlLmZyb20pLCBuZXcgRGF0ZShyZXNwb25zZS51bnRpbCksIHJlc3BvbnNlLmxhdCwgcmVzcG9uc2UubG5nLCByZXNwb25zZS5hZGRyZXNzKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSkuZXJyb3IoZnVuY3Rpb24gKGVycm9yKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNiKGVycm9yLCBudWxsKTtcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY2IoZXJyLCBudWxsKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSxcclxuXHJcbiAgICAgICAgZGVsZXRlRXZlbnQ6IGZ1bmN0aW9uIChldmVudCwgY2IpIHtcclxuICAgICAgICAgICAgJGh0dHAuZGVsZXRlKFwiL2FwaS9ldmVudC9cIiArIGV2ZW50LmlkKS5zdWNjZXNzKGZ1bmN0aW9uIChkYXRhKSB7XHJcbiAgICAgICAgICAgICAgICBjYihudWxsLCBkYXRhKTtcclxuICAgICAgICAgICAgfSkuZXJyb3IoZnVuY3Rpb24gKGVycm9yKSB7XHJcbiAgICAgICAgICAgICAgICBjYihlcnJvciwgbnVsbCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbn07XHJcblxyXG5hbmd1bGFyLm1vZHVsZShcImdlb2ZlZWxpbmdzXCIpLmZhY3RvcnkoXCJldmVudFNlcnZpY2VcIiwgW1wiJGh0dHBcIiwgXCJnb29nbGVNYXBzU2VydmljZVwiLCBldmVudFNlcnZpY2VdKTsiLCIvKipcclxuICogQ3JlYXRlZCBieSBKb25hdGFuIG9uIDIyLzEyLzIwMTUuXHJcbiAqL1xyXG5cclxuLy8gaHR0cHM6Ly9kZXZlbG9wZXJzLmdvb2dsZS5jb20vbWFwcy9kb2N1bWVudGF0aW9uL2dlb2NvZGluZy9pbnRybz9jc3c9MSNHZW9jb2RpbmdcclxuLy8gRGl0IGdlYnJ1aWtlbiBvbSBhZHJlc3NlbiB0ZSB2ZXJ0YWxlbiBuYWFyIGxhdCBlbiBsbmcgb2Ygb21nZWtlZXJkXHJcbi8vIFdhYXJvbT8gPT4gZ29vZ2xlIG1hcHMgd2Vya3QgbWV0IGxhdCBlbiBsbmcsIHdvcmR0IHpvIG9wZ2VzbGFhbiBpbiBkZSBkYXRhYmFzZVxyXG5cclxudmFyIGdvb2dsZU1hcHNTZXJ2aWNlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgXCJ1c2Ugc3RyaWN0XCI7XHJcbiAgICAvLyBwcml2YXRlXHJcbiAgICB2YXIgbWFwb3B0aW9ucyA9IHtcclxuICAgICAgICB6b29tOiAxMCxcclxuICAgICAgICBtYXBUeXBlSWQ6IGdvb2dsZS5tYXBzLk1hcFR5cGVJZC5ST0FETUFQLFxyXG4gICAgICAgIGRpc2FibGVEZWZhdWx0VUk6IHRydWVcclxuICAgIH07XHJcbiAgICB2YXIgZ2VvY29kZXIgPSBuZXcgZ29vZ2xlLm1hcHMuR2VvY29kZXIoKTtcclxuICAgIHZhciBtYXAgPSBuZXcgZ29vZ2xlLm1hcHMuTWFwKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoXCIjbWFwXCIpLCBtYXBvcHRpb25zKTtcclxuICAgIHZhciBtYXJrZXJzID0gW107XHJcblxyXG4gICAgdmFyIGNob29zZUljb24gPSBmdW5jdGlvbiAobW9vZCkge1xyXG4gICAgICAgIHZhciB1cmwgPSBcImh0dHA6Ly9zdHVkZW50Lmhvd2VzdC5iZS9qb25hdGFuLm1pY2hpZWxzL2dlb2ZlZWxpbmdzL2Fzc2V0cy9cIjtcclxuICAgICAgICBpZiAobW9vZCA8PSAyMCkge1xyXG4gICAgICAgICAgICByZXR1cm4gdXJsICs9IFwiZGVwcmVzc2VkLnBuZ1wiO1xyXG4gICAgICAgIH0gZWxzZSBpZiAobW9vZCA+IDIwICYmIG1vb2QgPD0gNDApIHtcclxuICAgICAgICAgICAgcmV0dXJuIHVybCArPSBcInNhZC5wbmdcIjtcclxuICAgICAgICB9IGVsc2UgaWYgKG1vb2QgPiA0MCAmJiBtb29kIDw9IDYwKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB1cmwgKz0gXCJjb21tb24ucG5nXCI7XHJcbiAgICAgICAgfSBlbHNlIGlmIChtb29kID4gNjAgJiYgbW9vZCA8PSA4MCkge1xyXG4gICAgICAgICAgICByZXR1cm4gdXJsICs9IFwiaGFwcHkucG5nXCI7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmV0dXJuIHVybCArPSBcImV4Y2l0ZWQucG5nXCI7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuXHJcbiAgICAvL3B1YmxpY1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgICBzaG93TG9jYXRpb25Pbk1hcDogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICBpZiAobmF2aWdhdG9yLmdlb2xvY2F0aW9uKSB7XHJcbiAgICAgICAgICAgICAgICBuYXZpZ2F0b3IuZ2VvbG9jYXRpb24uZ2V0Q3VycmVudFBvc2l0aW9uKGZ1bmN0aW9uIChwb3NpdGlvbikge1xyXG4gICAgICAgICAgICAgICAgICAgIG1hcC5zZXRDZW50ZXIobmV3IGdvb2dsZS5tYXBzLkxhdExuZyhwb3NpdGlvbi5jb29yZHMubGF0aXR1ZGUsIHBvc2l0aW9uLmNvb3Jkcy5sb25naXR1ZGUpKTtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgbWFya2VyID0gbmV3IGdvb2dsZS5tYXBzLk1hcmtlcih7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uOiBtYXAuZ2V0Q2VudGVyKCksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1hcDogbWFwLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpY29uOiBcImh0dHA6Ly9zdHVkZW50Lmhvd2VzdC5iZS9qb25hdGFuLm1pY2hpZWxzL2dlb2ZlZWxpbmdzL2Fzc2V0cy9sb2NhdGlvbl9ub3cucG5nXCJcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICBtYXJrZXJzLnB1c2gobWFya2VyKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgLy8gVGhyb3cgbWFwIGV4Y2VwdGlvblxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSxcclxuXHJcbiAgICAgICAgcmVtb3ZlTWFya2VyczogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG1hcmtlcnMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgIG1hcmtlcnNbaV0uc2V0TWFwKG51bGwpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSxcclxuXHJcbiAgICAgICAgc2hvd09uZVBvc3RNYXJrZXI6IGZ1bmN0aW9uIChkYXRhKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGRhdGEpO1xyXG4gICAgICAgICAgICB2YXIgbWFya2VyID0gbmV3IGdvb2dsZS5tYXBzLk1hcmtlcih7XHJcbiAgICAgICAgICAgICAgICBwb3NpdGlvbjogbmV3IGdvb2dsZS5tYXBzLkxhdExuZyhkYXRhLmxhdCwgZGF0YS5sbmcpLFxyXG4gICAgICAgICAgICAgICAgbWFwOiBtYXAsXHJcbiAgICAgICAgICAgICAgICBpY29uOiBjaG9vc2VJY29uKGRhdGEubW9vZClcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICBpZiAoIWRhdGEucmVhc29uKSB7XHJcbiAgICAgICAgICAgICAgICBkYXRhLnJlYXNvbiA9IFwiUmFuZG9tIHBvc3Qgd2l0aCBubyByZWFzb24hXCI7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmICghZGF0YS5ldmVudCkge1xyXG4gICAgICAgICAgICAgICAgZGF0YS5ldmVudC5ldmVudG5hbWUgPSBcIk5vIGV2ZW50IGRhdGFcIjtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgdmFyIGluZm9XaW5kb3cgPSBuZXcgZ29vZ2xlLm1hcHMuSW5mb1dpbmRvdygpO1xyXG4gICAgICAgICAgICB2YXIgY29udGVudCA9IFwiPGg0IGNsYXNzPSdpbmZvd2luZG93c3R5bGUnPiBTaGFyZSBkZXRhaWxzIDwvaDQ+XCIgK1xyXG4gICAgICAgICAgICAgICAgXCI8cCBjbGFzcz0naW5mb3dpbmRvd3N0eWxlJz4gVGltZTogPHNwYW4+XCIgKyBuZXcgRGF0ZShkYXRhLnRpbWUpICtcclxuICAgICAgICAgICAgICAgIFwiPHAgY2xhc3M9J2luZm93aW5kb3dzdHlsZSc+IE1vb2Q6IDxzcGFuPlwiICsgZGF0YS5tb29kICsgXCIlPC9zcGFuPjwvcD5cIiArXHJcbiAgICAgICAgICAgICAgICBcIjxwIGNsYXNzPSdpbmZvd2luZG93c3R5bGUnPiBSZWFzb246IDxzcGFuPlwiICsgZGF0YS5yZWFzb24gKyBcIjwvc3Bhbj48L3A+XCIgKyBcIjwvc3Bhbj48L3A+XCIgK1xyXG4gICAgICAgICAgICAgICAgXCI8cCBjbGFzcz0naW5mb3dpbmRvd3N0eWxlJz4gVXNlcjogPHNwYW4+XCIgKyBkYXRhLnVzZXIudXNlcm5hbWUgKyBcIjwvc3Bhbj48L3A+XCIgK1xyXG4gICAgICAgICAgICAgICAgXCI8cCBjbGFzcz0naW5mb3dpbmRvd3N0eWxlJz4gQWRkcmVzczogPHNwYW4+XCIgKyBkYXRhLmFkZHJlc3MgKyBcIjwvc3Bhbj48L3A+XCIgK1xyXG4gICAgICAgICAgICAgICAgXCI8cCBjbGFzcz0naW5mb3dpbmRvd3N0eWxlJz4gRXZlbnQ6IDxzcGFuPlwiICsgZGF0YS5ldmVudC5ldmVudG5hbWUgKyBcIjwvc3Bhbj48L3A+XCI7XHJcblxyXG4gICAgICAgICAgICBnb29nbGUubWFwcy5ldmVudC5hZGRMaXN0ZW5lcihtYXJrZXIsIFwiY2xpY2tcIiwgKGZ1bmN0aW9uIChtYXJrZXIsIGNvbnRlbnQsIGluZm9XaW5kb3cpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaW5mb1dpbmRvdy5zZXRDb250ZW50KGNvbnRlbnQpO1xyXG4gICAgICAgICAgICAgICAgICAgIGluZm9XaW5kb3cub3BlbihtYXAsIG1hcmtlcik7XHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICB9KShtYXJrZXIsIGNvbnRlbnQsIGluZm9XaW5kb3cpKTtcclxuXHJcbiAgICAgICAgfSxcclxuXHJcbiAgICAgICAgc2hvd0FsbE1hcmtlcnM6IGZ1bmN0aW9uIChkYXRhKSB7XHJcbiAgICAgICAgICAgIHZhciBtYXJrZXIsIGk7XHJcbiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICBtYXJrZXIgPSBuZXcgZ29vZ2xlLm1hcHMuTWFya2VyKHtcclxuICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbjogbmV3IGdvb2dsZS5tYXBzLkxhdExuZyhkYXRhW2ldLmxhdCwgZGF0YVtpXS5sbmcpLFxyXG4gICAgICAgICAgICAgICAgICAgIG1hcDogbWFwLFxyXG4gICAgICAgICAgICAgICAgICAgIGljb246IGNob29zZUljb24oZGF0YVtpXS5tb29kKVxyXG4gICAgICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKCFkYXRhW2ldLnJlYXNvbikge1xyXG4gICAgICAgICAgICAgICAgICAgIGRhdGFbaV0ucmVhc29uID0gXCJSYW5kb20gcG9zdCB3aXRoIG5vIHJlYXNvbiFcIjtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICBpZiAoIWRhdGFbaV0uZXZlbnQuZXZlbnRuYW1lKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZGF0YVtpXS5ldmVudC5ldmVudG5hbWUgPSBcIk5vIGV2ZW50IGRhdGFcIjtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICB2YXIgaW5mb1dpbmRvdyA9IG5ldyBnb29nbGUubWFwcy5JbmZvV2luZG93KCk7XHJcbiAgICAgICAgICAgICAgICB2YXIgY29udGVudCA9IFwiPGg0IGNsYXNzPSdpbmZvd2luZG93c3R5bGUnPiBTaGFyZSBkZXRhaWxzIDwvaDQ+XCIgK1xyXG4gICAgICAgICAgICAgICAgICAgIFwiPHAgY2xhc3M9J2luZm93aW5kb3dzdHlsZSc+IFRpbWU6IDxzcGFuPlwiICsgbmV3IERhdGUoZGF0YVtpXS50aW1lKSArXHJcbiAgICAgICAgICAgICAgICAgICAgXCI8cCBjbGFzcz0naW5mb3dpbmRvd3N0eWxlJz4gTW9vZDogPHNwYW4+XCIgKyBkYXRhW2ldLm1vb2QgKyBcIiU8L3NwYW4+PC9wPlwiICtcclxuICAgICAgICAgICAgICAgICAgICBcIjxwIGNsYXNzPSdpbmZvd2luZG93c3R5bGUnPiBSZWFzb246IDxzcGFuPlwiICsgZGF0YVtpXS5yZWFzb24gKyBcIjwvc3Bhbj48L3A+XCIgKyBcIjwvc3Bhbj48L3A+XCIgK1xyXG4gICAgICAgICAgICAgICAgICAgIFwiPHAgY2xhc3M9J2luZm93aW5kb3dzdHlsZSc+IFVzZXI6IDxzcGFuPlwiICsgZGF0YVtpXS51c2VyLnVzZXJuYW1lICsgXCI8L3NwYW4+PC9wPlwiICtcclxuICAgICAgICAgICAgICAgICAgICBcIjxwIGNsYXNzPSdpbmZvd2luZG93c3R5bGUnPiBBZGRyZXNzOiA8c3Bhbj5cIiArIGRhdGFbaV0uYWRkcmVzcyArIFwiPC9zcGFuPjwvcD5cIiArXHJcbiAgICAgICAgICAgICAgICAgICAgXCI8cCBjbGFzcz0naW5mb3dpbmRvd3N0eWxlJz4gRXZlbnQ6IDxzcGFuPlwiICsgZGF0YVtpXS5ldmVudC5ldmVudG5hbWUgKyBcIjwvc3Bhbj48L3A+XCI7XHJcblxyXG4gICAgICAgICAgICAgICAgbWFya2Vycy5wdXNoKG1hcmtlcik7XHJcbiAgICAgICAgICAgICAgICBnb29nbGUubWFwcy5ldmVudC5hZGRMaXN0ZW5lcihtYXJrZXIsIFwiY2xpY2tcIiwgKGZ1bmN0aW9uIChtYXJrZXIsIGNvbnRlbnQsIGluZm9XaW5kb3cpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpbmZvV2luZG93LnNldENvbnRlbnQoY29udGVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGluZm9XaW5kb3cub3BlbihtYXAsIG1hcmtlcik7XHJcbiAgICAgICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgIH0pKG1hcmtlciwgY29udGVudCwgaW5mb1dpbmRvdykpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSxcclxuXHJcbiAgICAgICAgY29udmVydEFkcmVzc1RvQ29vcmRpbmF0ZXM6IGZ1bmN0aW9uIChhZGRyZXNzLCBjYikge1xyXG4gICAgICAgICAgICBnZW9jb2Rlci5nZW9jb2RlKHthZGRyZXNzOiBhZGRyZXNzfSwgZnVuY3Rpb24gKHJlc3VsdHMsIHN0YXR1cykge1xyXG4gICAgICAgICAgICAgICAgaWYgKHN0YXR1cyA9PSBnb29nbGUubWFwcy5HZW9jb2RlclN0YXR1cy5PSykge1xyXG4gICAgICAgICAgICAgICAgICAgIGNiKG51bGwsIHJlc3VsdHNbMF0uZ2VvbWV0cnkubG9jYXRpb24pO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBjYihzdGF0dXMsIG51bGwpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9LFxyXG5cclxuICAgICAgICBjb252ZXJ0Q29vcmRpbmF0ZXNUb0FkcmVzczogZnVuY3Rpb24gKGxhdCwgbG5nLCBjYikge1xyXG4gICAgICAgICAgICB2YXIgbG9jYXRpb24gPSBuZXcgZ29vZ2xlLm1hcHMuTGF0TG5nKGxhdCwgbG5nKTtcclxuICAgICAgICAgICAgZ2VvY29kZXIuZ2VvY29kZSh7bGF0TG5nOiBsb2NhdGlvbn0sIGZ1bmN0aW9uIChyZXN1bHRzLCBzdGF0dXMpIHtcclxuICAgICAgICAgICAgICAgIGlmIChzdGF0dXMgPT0gZ29vZ2xlLm1hcHMuR2VvY29kZXJTdGF0dXMuT0spIHtcclxuICAgICAgICAgICAgICAgICAgICBjYihudWxsLCByZXN1bHRzWzBdLmZvcm1hdHRlZF9hZGRyZXNzKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RhdHVzID09IGdvb2dsZS5tYXBzLkdlb2NvZGVyU3RhdHVzLk9WRVJfUVVFUllfTElNSVQpIHtcclxuICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2IobnVsbCwgcmVzdWx0c1swXS5mb3JtYXR0ZWRfYWRkcmVzcyk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSwgMjAwKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY2Ioc3RhdHVzLCBudWxsKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxufTtcclxuXHJcbmFuZ3VsYXIubW9kdWxlKFwiZ2VvZmVlbGluZ3NcIikuZmFjdG9yeShcImdvb2dsZU1hcHNTZXJ2aWNlXCIsIFtnb29nbGVNYXBzU2VydmljZV0pOyIsIi8qKlxyXG4gKiBDcmVhdGVkIGJ5IEpvbmF0YW4gb24gMjcvMTIvMjAxNS5cclxuICovXHJcblxyXG52YXIgcHJvZmlsZVNlcnZpY2UgPSBmdW5jdGlvbiAoJGh0dHAsIGdvb2dsZU1hcHNTZXJ2aWNlKSB7XHJcbiAgICBcInVzZSBzdHJpY3RcIjtcclxuICAgIC8vIHByaXZhdGVcclxuXHJcbiAgICAvL3B1YmxpY1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgICBnZXRVc2VyOiBmdW5jdGlvbiAoY2IpIHtcclxuICAgICAgICAgICAgJGh0dHAuZ2V0KFwiL2F1dGgvdXNlclwiKS5zdWNjZXNzKGZ1bmN0aW9uIChkYXRhKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZGF0YS5yZWRpcmVjdCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNiKG51bGwsIGRhdGEpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBjYihudWxsLCBuZXcgR2ZVc2VyKGRhdGEuX2lkLCBkYXRhLnVzZXJuYW1lLCBkYXRhLmVtYWlsLCBkYXRhLnVzZXJpbWFnZSwgbmV3IERhdGUoZGF0YS5hZ2UpLCBkYXRhLmxhdCwgZGF0YS5sbmcsIGRhdGEuYWRkcmVzcywgZGF0YS5jaGF0LCBkYXRhLmFkbWluKSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pLmVycm9yKGZ1bmN0aW9uIChlcnJvcikge1xyXG4gICAgICAgICAgICAgICAgY2IoZXJyb3IsIG51bGwpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9LFxyXG5cclxuICAgICAgICBzYXZlVXNlcjogZnVuY3Rpb24gKHVzZXIsIGNiKSB7XHJcbiAgICAgICAgICAgIGdvb2dsZU1hcHNTZXJ2aWNlLmNvbnZlcnRBZHJlc3NUb0Nvb3JkaW5hdGVzKHVzZXIuYWRkcmVzcywgZnVuY3Rpb24gKGVyciwgY29vcmQpIHtcclxuICAgICAgICAgICAgICAgIGlmICghZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdXNlci5sYXQgPSBjb29yZC5sYXQoKTtcclxuICAgICAgICAgICAgICAgICAgICB1c2VyLmxuZyA9IGNvb3JkLmxuZygpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAkaHR0cC5wdXQoXCIvYXBpL3VzZXIvXCIgKyB1c2VyLmlkLCB1c2VyKS5zdWNjZXNzKGZ1bmN0aW9uIChkYXRhKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkYXRhLnJlZGlyZWN0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYihudWxsLCBkYXRhKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNiKG51bGwsIG5ldyBHZlVzZXIoZGF0YS5faWQsIGRhdGEudXNlcm5hbWUsIGRhdGEuZW1haWwsIGRhdGEudXNlcmltYWdlLCBuZXcgRGF0ZShkYXRhLmFnZSksIGRhdGEubGF0LCBkYXRhLmxuZywgZGF0YS5hZGRyZXNzLCBkYXRhLmNoYXQsIGRhdGEuYWRtaW4pKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH0pLmVycm9yKGZ1bmN0aW9uIChlcnJvcikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjYihlcnJvciwgbnVsbCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGNiKGVyciwgbnVsbCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0sXHJcblxyXG4gICAgICAgIGxvZ291dDogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICByZXR1cm4gJGh0dHAuZ2V0KFwiL2F1dGgvbG9nb3V0XCIpLnRoZW4oZnVuY3Rpb24gKGRhdGEpIHtcclxuXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZGF0YTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxufTtcclxuXHJcbmFuZ3VsYXIubW9kdWxlKFwiZ2VvZmVlbGluZ3NcIikuZmFjdG9yeShcInByb2ZpbGVTZXJ2aWNlXCIsIFtcIiRodHRwXCIsIFwiZ29vZ2xlTWFwc1NlcnZpY2VcIiwgcHJvZmlsZVNlcnZpY2VdKTsiLCIvKipcclxuICogQ3JlYXRlZCBieSBMaWVuZXJ0IG9uIDIzLzEyLzIwMTUuXHJcbiAqL1xyXG5cclxuLyoqXHJcbiAqIE9QTUVSS0lORyBWT09SIExJRU5FUlQhISEhXHJcbiAqIHBvc3Qgc2hhcmUgemFsIG5pZXQgd2Vya2VuXHJcbiAqIGltcGxlbWVudGVlciBnb29nbGVTZXJ2aWNlXHJcbiAqIHZvb3JiZWVsZCBrYW4gamUgdmluZGVuIGluIHByb2ZpbGVzZXJ2aWNlIChwdXQgZnVuY3RpZSlcclxuICogR3JvZXRqZXMgSm9uYXRhblxyXG4gKi9cclxuXHJcblxyXG52YXIgc2hhcmVTZXJ2aWNlID0gZnVuY3Rpb24gKCRodHRwLCAkcSwgJGxvY2F0aW9uLCBnb29nbGVNYXBzU2VydmljZSwgZXZlbnRTZXJ2aWNlLCB1c2VyU2VydmljZSwgc2hhcmVWYXJzQmV0d2VlbkN0cmwpIHtcclxuICAgIFwidXNlIHN0cmljdFwiO1xyXG5cclxuICAgIC8vcHJpdmF0ZVxyXG4gICAgdmFyIG1ha2VBZGRyZXNzID0gZnVuY3Rpb24gKGFkZHJlc3MpIHtcclxuICAgICAgICBpZiAoYWRkcmVzcykge1xyXG4gICAgICAgICAgICB2YXIgc3BsaXQgPSBhZGRyZXNzLnNwbGl0KFwiLFwiKTtcclxuICAgICAgICAgICAgcmV0dXJuIHNwbGl0WzBdICsgXCIsIFwiICsgc3BsaXRbMV07XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuXHJcbiAgICB2YXIgcG9zdFNoYXJlID0gZnVuY3Rpb24gKGRhdGEpIHtcclxuICAgICAgICAkaHR0cCh7XHJcbiAgICAgICAgICAgIHVybDogJ2h0dHA6Ly9sb2NhbGhvc3Q6MzAwMC9hcGkvc2hhcmUnLFxyXG4gICAgICAgICAgICBtZXRob2Q6ICdQT1NUJyxcclxuICAgICAgICAgICAgZGF0YTogZGF0YVxyXG4gICAgICAgIH0pLnN1Y2Nlc3MoZnVuY3Rpb24gKHNlcnZlckRhdGEpIHtcclxuICAgICAgICAgICAgc2hhcmVWYXJzQmV0d2VlbkN0cmwuc2V0UHJvcGVydHkoc2VydmVyRGF0YSk7IC8vZGF0YSBrdW5uZW4gZG9vcmdldmVuIGFhbiBpbnRyb19zaGFyZWRDb250cm9sbGVyXHJcbiAgICAgICAgICAgICRsb2NhdGlvbi5wYXRoKFwiaW50cm9fc2hhcmVkXCIpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuXHJcbiAgICAvL3B1YmxpY1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgICBwb3N0U2hhcmU6IHBvc3RTaGFyZSxcclxuXHJcbiAgICAgICAgcG9zdFNoYXJlQXN5bmM6IGZ1bmN0aW9uIChkYXRhLCBjYikge1xyXG4gICAgICAgICAgICBpZiAoZGF0YS5hZGRyZXNzKSB7XHJcbiAgICAgICAgICAgICAgICAkaHR0cC5wb3N0KFwiL2FwaS9zaGFyZVwiLCBkYXRhKS5zdWNjZXNzKGZ1bmN0aW9uIChyZXNwb25zZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChyZXNwb25zZS5yZWRpcmVjdCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjYihudWxsLCByZXNwb25zZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2IobnVsbCwgbmV3IEdmU2hhcmUoZGF0YS5faWQsIGRhdGEudXNlcmlkLCBkYXRhLmV2ZW50aWQsIGRhdGEudGltZSwgZGF0YS5tb29kLCBkYXRhLmxhdCwgZGF0YS5sbmcsIG1ha2VBZGRyZXNzKGRhdGEuYWRkcmVzcyksIGRhdGEucmVhc29uKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSkuZXJyb3IoZnVuY3Rpb24gKGVycm9yKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY2IoZXJyb3IsIG51bGwpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBnb29nbGVNYXBzU2VydmljZS5jb252ZXJ0Q29vcmRpbmF0ZXNUb0FkcmVzcyhkYXRhLmxhdCwgZGF0YS5sbmcsIGZ1bmN0aW9uIChlcnIsIGFkZHJlc3MpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoIWVycikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAkaHR0cC5wb3N0KFwiL2FwaS9zaGFyZVwiLCBkYXRhKS5zdWNjZXNzKGZ1bmN0aW9uIChyZXNwb25zZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3BvbnNlLnJlZGlyZWN0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2IobnVsbCwgcmVzcG9uc2UpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYihudWxsLCBuZXcgR2ZTaGFyZShkYXRhLl9pZCwgZGF0YS51c2VyaWQsIGRhdGEuZXZlbnRpZCwgZGF0YS50aW1lLCBkYXRhLm1vb2QsIGRhdGEubGF0LCBkYXRhLmxuZywgbWFrZUFkZHJlc3MoYWRkcmVzcyksIGRhdGEucmVhc29uKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pLmVycm9yKGZ1bmN0aW9uIChlcnJvcikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2IoZXJyb3IsIG51bGwpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjYihlcnIsIG51bGwpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSxcclxuXHJcbiAgICAgICAgZ2V0U2hhcmVzQnlVc2VySWQ6IGZ1bmN0aW9uICh1c2VyaWQsIGNiKSB7XHJcbiAgICAgICAgICAgICRodHRwLmdldChcIi9hcGkvc2hhcmUvdXNlci9cIiArIHVzZXJpZCkuc3VjY2VzcyhmdW5jdGlvbiAoZGF0YSkge1xyXG4gICAgICAgICAgICAgICAgaWYgKGRhdGEucmVkaXJlY3QpIHtcclxuICAgICAgICAgICAgICAgICAgICBjYihudWxsLCBkYXRhKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIHNoYXJlcyA9IFtdO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBhbmd1bGFyLmZvckVhY2goZGF0YSwgZnVuY3Rpb24gKHNoYXJlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHVzZXJTZXJ2aWNlLmdldFVzZXJCeUlkRm9yU2hhcmUoc2hhcmUudXNlcmlkLCBmdW5jdGlvbihlcnIsIHVzZXIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKCFlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaGFyZS51c2VyID0gdXNlcjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudFNlcnZpY2UuZ2V0RXZlbnRCeUlkRm9yU2hhcmUoc2hhcmUuZXZlbnRpZCwgZnVuY3Rpb24oZXJyLCBldmVudCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZighZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaGFyZS5ldmVudCA9IGV2ZW50O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2hhcmVzLnB1c2gobmV3IEdmU2hhcmVFeHRlbmRlZChzaGFyZS5faWQsIHNoYXJlLnVzZXIsIHNoYXJlLmV2ZW50LCBzaGFyZS50aW1lLCBzaGFyZS5tb29kLCBzaGFyZS5sYXQsIHNoYXJlLmxuZywgbWFrZUFkZHJlc3Moc2hhcmUuYWRkcmVzcyksIHNoYXJlLnJlYXNvbikpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGRhdGEubGVuZ3RoID09PSBzaGFyZXMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2IobnVsbCwgc2hhcmVzKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSkuZXJyb3IoZnVuY3Rpb24gKGVycm9yKSB7XHJcbiAgICAgICAgICAgICAgICBjYihlcnJvciwgbnVsbCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0sXHJcblxyXG4gICAgICAgIGdldFNoYXJlc0J5RXZlbnRJZDogZnVuY3Rpb24gKGV2ZW50aWQsIGNiKSB7XHJcbiAgICAgICAgICAgICRodHRwLmdldChcIi9hcGkvc2hhcmUvZXZlbnQvXCIgKyBldmVudGlkKS5zdWNjZXNzKGZ1bmN0aW9uIChkYXRhKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZGF0YS5yZWRpcmVjdCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNiKG51bGwsIGRhdGEpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgc2hhcmVzID0gW107XHJcbiAgICAgICAgICAgICAgICAgICAgYW5ndWxhci5mb3JFYWNoKGRhdGEsIGZ1bmN0aW9uIChzaGFyZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB1c2VyU2VydmljZS5nZXRVc2VyQnlJZEZvclNoYXJlKHNoYXJlLnVzZXJpZCwgZnVuY3Rpb24oZXJyLCB1c2VyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZighZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2hhcmUudXNlciA9IHVzZXI7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnRTZXJ2aWNlLmdldEV2ZW50QnlJZEZvclNoYXJlKHNoYXJlLmV2ZW50aWQsIGZ1bmN0aW9uKGVyciwgZXZlbnQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoIWVycikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2hhcmUuZXZlbnQgPSBldmVudDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNoYXJlcy5wdXNoKG5ldyBHZlNoYXJlRXh0ZW5kZWQoc2hhcmUuX2lkLCBzaGFyZS51c2VyLCBzaGFyZS5ldmVudCwgc2hhcmUudGltZSwgc2hhcmUubW9vZCwgc2hhcmUubGF0LCBzaGFyZS5sbmcsIG1ha2VBZGRyZXNzKHNoYXJlLmFkZHJlc3MpLCBzaGFyZS5yZWFzb24pKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihkYXRhLmxlbmd0aCA9PT0gc2hhcmVzLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNiKG51bGwsIHNoYXJlcyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pLmVycm9yKGZ1bmN0aW9uIChlcnJvcikge1xyXG4gICAgICAgICAgICAgICAgY2IoZXJyb3IsIG51bGwpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9LFxyXG5cclxuICAgICAgICBnZXRBbGxTaGFyZXM6IGZ1bmN0aW9uIChjYikge1xyXG4gICAgICAgICAgICAkaHR0cC5nZXQoXCIvYXBpL3NoYXJlXCIpLnN1Y2Nlc3MoZnVuY3Rpb24gKGRhdGEpIHtcclxuICAgICAgICAgICAgICAgIHZhciBzaGFyZXMgPSBbXTtcclxuICAgICAgICAgICAgICAgIGFuZ3VsYXIuZm9yRWFjaChkYXRhLCBmdW5jdGlvbiAoc2hhcmUpIHtcclxuICAgICAgICAgICAgICAgICAgICB1c2VyU2VydmljZS5nZXRVc2VyQnlJZEZvclNoYXJlKHNoYXJlLnVzZXJpZCwgZnVuY3Rpb24oZXJyLCB1c2VyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKCFlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNoYXJlLnVzZXIgPSB1c2VyO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnRTZXJ2aWNlLmdldEV2ZW50QnlJZEZvclNoYXJlKHNoYXJlLmV2ZW50aWQsIGZ1bmN0aW9uKGVyciwgZXZlbnQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZighZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNoYXJlLmV2ZW50ID0gZXZlbnQ7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNoYXJlcy5wdXNoKG5ldyBHZlNoYXJlRXh0ZW5kZWQoc2hhcmUuX2lkLCBzaGFyZS51c2VyLCBzaGFyZS5ldmVudCwgc2hhcmUudGltZSwgc2hhcmUubW9vZCwgc2hhcmUubGF0LCBzaGFyZS5sbmcsIG1ha2VBZGRyZXNzKHNoYXJlLmFkZHJlc3MpLCBzaGFyZS5yZWFzb24pKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGRhdGEubGVuZ3RoID09PSBzaGFyZXMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYihudWxsLCBzaGFyZXMpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9KS5lcnJvcihmdW5jdGlvbiAoZXJyb3IpIHtcclxuICAgICAgICAgICAgICAgIGNiKGVycm9yLCBudWxsKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSxcclxuXHJcbiAgICAgICAgZGVsZXRlU2hhcmU6IGZ1bmN0aW9uIChzaGFyZSwgY2IpIHtcclxuICAgICAgICAgICAgJGh0dHAuZGVsZXRlKFwiL2FwaS9zaGFyZS9cIiArIHNoYXJlLmlkKS5zdWNjZXNzKGZ1bmN0aW9uIChkYXRhKSB7XHJcbiAgICAgICAgICAgICAgICBjYihudWxsLCBkYXRhKTtcclxuICAgICAgICAgICAgfSkuZXJyb3IoZnVuY3Rpb24gKGVycm9yKSB7XHJcbiAgICAgICAgICAgICAgICBjYihlcnJvciwgbnVsbCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbn07XHJcbmFuZ3VsYXIubW9kdWxlKFwiZ2VvZmVlbGluZ3NcIikuZmFjdG9yeShcInNoYXJlU2VydmljZVwiLCBbXCIkaHR0cFwiLCBcIiRxXCIsIFwiJGxvY2F0aW9uXCIsIFwiZ29vZ2xlTWFwc1NlcnZpY2VcIiwgXCJldmVudFNlcnZpY2VcIiwgXCJ1c2VyU2VydmljZVwiLCBcInNoYXJlVmFyc0JldHdlZW5DdHJsXCIsIHNoYXJlU2VydmljZV0pO1xyXG4iLCIvKipcclxuICogQ3JlYXRlZCBieSBsaWVuZSBvbiAyOC8xMi8yMDE1LlxyXG4gKi9cclxuXHJcblxyXG52YXIgc2hhcmVWYXJzQmV0d2VlbkN0cmwgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICBcInVzZSBzdHJpY3RcIjtcclxuXHJcbiAgICAvL3ByaXZhdGVcclxuICAgIHZhciBwcm9wZXJ0eTtcclxuICAgIHZhciB1c2VybGVzc1NoYXJlO1xyXG4gICAgdmFyIEV4dHJhTG9naW5JbmZvO1xyXG4gICAgLy9wdWJsaWNcclxuICAgIHJldHVybiB7XHJcblxyXG4gICAgICAgIGdldFByb3BlcnR5OiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBwcm9wZXJ0eTtcclxuICAgICAgICB9LFxyXG5cclxuICAgICAgICBzZXRQcm9wZXJ0eTogZnVuY3Rpb24gKHZhbHVlKSB7XHJcbiAgICAgICAgICAgIHByb3BlcnR5ID0gdmFsdWU7XHJcbiAgICAgICAgfSxcclxuXHJcbiAgICAgICAgc2V0RXh0cmFMb2dpbkluZm86IGZ1bmN0aW9uIChkYXRhKSB7XHJcbiAgICAgICAgICAgIEV4dHJhTG9naW5JbmZvID0gZGF0YTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIGdldEV4dHJhTG9naW5JbmZvOiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBFeHRyYUxvZ2luSW5mbztcclxuICAgICAgICB9LFxyXG5cclxuICAgICAgICBzYXZlVXNlcmxlc3NTaGFyZTogZnVuY3Rpb24gKGRhdGEpIHtcclxuICAgICAgICAgICAgdXNlcmxlc3NTaGFyZSA9IGRhdGE7XHJcbiAgICAgICAgfSxcclxuICAgICAgICByZXR1cm5Vc2VybGVzc1NoYXJlOiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB1c2VybGVzc1NoYXJlO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbn07XHJcblxyXG5hbmd1bGFyLm1vZHVsZShcImdlb2ZlZWxpbmdzXCIpLmZhY3RvcnkoXCJzaGFyZVZhcnNCZXR3ZWVuQ3RybFwiLCBbc2hhcmVWYXJzQmV0d2VlbkN0cmxdKTsiLCIoZnVuY3Rpb24gKCkge1xyXG4gICAgXCJ1c2Ugc3RyaWN0XCI7XHJcblxyXG4gICAgdmFyIHVzZXJTZXJ2aWNlID0gZnVuY3Rpb24gKCRodHRwKSB7XHJcblxyXG4gICAgICAgIHZhciBnZXRBbGxVc2VycyA9IGZ1bmN0aW9uIChjYikge1xyXG4gICAgICAgICAgICAkaHR0cC5nZXQoXCIvYXBpL3VzZXJcIikuc3VjY2VzcyhmdW5jdGlvbiAoZGF0YSkge1xyXG4gICAgICAgICAgICAgICAgaWYgKGRhdGEucmVkaXJlY3QpIHtcclxuICAgICAgICAgICAgICAgICAgICBjYihudWxsLCBkYXRhKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcblxyXG4gICAgICAgICAgICAgICAgdmFyIGFyU2VhcmNoUmVzdWx0cyA9IFtdO1xyXG4gICAgICAgICAgICAgICAgICAgIGFuZ3VsYXIuZm9yRWFjaChkYXRhLCBmdW5jdGlvbiAoc2VhcmNoUikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgbmV3U1IgPSBuZXcgU2VhcmNoUmVzdWx0KHNlYXJjaFIudXNlcm5hbWUsIHNlYXJjaFIuZW1haWwsIHNlYXJjaFIuX2lkLFwidXNlclwiKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYXJTZWFyY2hSZXN1bHRzLnB1c2gobmV3U1IpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIGNiKG51bGwsIGFyU2VhcmNoUmVzdWx0cyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pLmVycm9yKGZ1bmN0aW9uIChlcnJvcikge1xyXG4gICAgICAgICAgICAgICAgY2IoZXJyb3IsIG51bGwpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9O1xyXG5cclxuXHJcbiAgICAgICAgdmFyIHNlYXJjaFVzZXJGcm9tSWQgPSBmdW5jdGlvbiAoc2VhcmNoU3RyaW5nKSB7XHJcbiAgICAgICAgICAgIHZhciB1cmwgPSAnaHR0cDovL2xvY2FsaG9zdDozMDAwL2FwaS91c2VyLycgKyBzZWFyY2hTdHJpbmc7XHJcbiAgICAgICAgICAgIHJldHVybiAkaHR0cC5nZXQodXJsKS50aGVuKGZ1bmN0aW9uIChyZXNwb25zZSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBHZlVzZXIoXHJcbiAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5faWQsXHJcbiAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS51c2VybmFtZSxcclxuICAgICAgICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLmVtYWlsLFxyXG4gICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEudXNlcmltYWdlLFxyXG4gICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEuYWdlLFxyXG4gICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEubGF0LFxyXG4gICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEubG5nLFxyXG4gICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEuYWRkcmVzcyxcclxuICAgICAgICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLmNoYXQsXHJcbiAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5hZG1pblxyXG4gICAgICAgICAgICAgICAgKTtcclxuXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIGdldEFsbFVzZXJzOiBnZXRBbGxVc2VycyxcclxuICAgICAgICAgICAgc2VhcmNoVXNlckZyb21JZDogc2VhcmNoVXNlckZyb21JZCxcclxuICAgICAgICAgICAgZ2V0VXNlckJ5SWRGb3JTaGFyZTogZnVuY3Rpb24odXNlcmlkLCBjYikge1xyXG4gICAgICAgICAgICAgICAgJGh0dHAuZ2V0KFwiL2FwaS91c2VyL1wiICsgdXNlcmlkKS5zdWNjZXNzKGZ1bmN0aW9uKGRhdGEpIHtcclxuICAgICAgICAgICAgICAgICAgICBjYihudWxsLCBuZXcgR2ZVc2VyKGRhdGEuX2lkLCBkYXRhLnVzZXJuYW1lLCBudWxsLCBkYXRhLnVzZXJpbWFnZSwgbnVsbCwgbnVsbCwgbnVsbCwgbnVsbCwgbnVsbCwgbnVsbCkpO1xyXG4gICAgICAgICAgICAgICAgfSkuZXJyb3IoZnVuY3Rpb24gKGVycm9yKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY2IoZXJyb3IsIG51bGwpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG4gICAgfTtcclxuICAgIGFuZ3VsYXIubW9kdWxlKFwiZ2VvZmVlbGluZ3NcIikuZmFjdG9yeShcInVzZXJTZXJ2aWNlXCIsIFtcIiRodHRwXCIsIHVzZXJTZXJ2aWNlXSk7XHJcbn0pKCk7IiwiLyoqXHJcbiAqIENyZWF0ZWQgYnkgSm9uYXRhbiBvbiAyOC8xMi8yMDE1LlxyXG4gKi9cclxuXHJcbmZ1bmN0aW9uIEdmRXZlbnQoaWQsIGV2ZW50bmFtZSwgZXZlbnRpbWFnZSwgYXV0aG9yaWQsIGZyb20sIHVudGlsLCBsYXQsIGxuZywgYWRkcmVzcykge1xyXG4gICAgdGhpcy5pZCA9IGlkO1xyXG4gICAgdGhpcy5ldmVudG5hbWUgPSBldmVudG5hbWU7XHJcbiAgICB0aGlzLmV2ZW50aW1hZ2UgPSBldmVudGltYWdlO1xyXG4gICAgdGhpcy5hdXRob3JpZCA9IGF1dGhvcmlkO1xyXG4gICAgdGhpcy5mcm9tID0gZnJvbTtcclxuICAgIHRoaXMudW50aWwgPSB1bnRpbDtcclxuICAgIHRoaXMubGF0ID0gbGF0O1xyXG4gICAgdGhpcy5sbmcgPSBsbmc7XHJcbiAgICB0aGlzLmFkZHJlc3MgPSBhZGRyZXNzO1xyXG59XHJcblxyXG5HZlNoYXJlLnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uICgpIHtcclxuICAgIHJldHVybiB0aGlzLmV2ZW50bmFtZTtcclxufTsiLCJmdW5jdGlvbiBHZlNoYXJlKGlkLCB1c2VyaWQsIGV2ZW50aWQsIHRpbWUsIG1vb2QsIGxhdCwgbG5nLCBhZGRyZXNzLCByZWFzb24pIHtcclxuICAgIHRoaXMuaWQgPSBpZDtcclxuICAgIHRoaXMudXNlcmlkID0gdXNlcmlkO1xyXG4gICAgdGhpcy5ldmVudGlkID0gZXZlbnRpZDtcclxuICAgIHRoaXMudGltZSA9IHRpbWU7XHJcbiAgICB0aGlzLm1vb2QgPSBtb29kO1xyXG4gICAgdGhpcy5sYXQgPSBsYXQ7XHJcbiAgICB0aGlzLmxuZyA9IGxuZztcclxuICAgIHRoaXMuYWRkcmVzcyA9IGFkZHJlc3M7XHJcbiAgICB0aGlzLnJlYXNvbiA9IHJlYXNvbjtcclxufVxyXG5cclxuR2ZTaGFyZS5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICByZXR1cm4gdGhpcy51c2VyaWQgKyBcIiAoXCIgKyB0aGlzLnRpbWUgKyBcIilcIjtcclxufTtcclxuIiwiLyoqXHJcbiAqIENyZWF0ZWQgYnkgSm9uYXRhbiBvbiAzMS8xMi8yMDE1LlxyXG4gKi9cclxuXHJcbmZ1bmN0aW9uIEdmU2hhcmVFeHRlbmRlZChpZCwgdXNlciwgZXZlbnQsIHRpbWUsIG1vb2QsIGxhdCwgbG5nLCBhZGRyZXNzLCByZWFzb24pIHtcclxuICAgIHRoaXMuaWQgPSBpZDtcclxuICAgIHRoaXMudXNlciA9IHVzZXI7XHJcbiAgICB0aGlzLmV2ZW50ID0gZXZlbnQ7XHJcbiAgICB0aGlzLnRpbWUgPSB0aW1lO1xyXG4gICAgdGhpcy5tb29kID0gbW9vZDtcclxuICAgIHRoaXMubGF0ID0gbGF0O1xyXG4gICAgdGhpcy5sbmcgPSBsbmc7XHJcbiAgICB0aGlzLmFkZHJlc3MgPSBhZGRyZXNzO1xyXG4gICAgdGhpcy5yZWFzb24gPSByZWFzb247XHJcbn1cclxuXHJcbkdmU2hhcmUucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24gKCkge1xyXG4gICAgcmV0dXJuIHRoaXMudXNlcmlkICsgXCIgKFwiICsgdGhpcy50aW1lICsgXCIpXCI7XHJcbn07IiwiZnVuY3Rpb24gR2ZVc2VyKGlkLCB1c2VybmFtZSwgZW1haWwsIHVzZXJpbWFnZSwgYWdlLCBsYXQsIGxuZywgYWRkcmVzcywgY2hhdCwgYWRtaW4pIHtcclxuICAgIHRoaXMuaWQgPSBpZDtcclxuICAgIHRoaXMudXNlcm5hbWUgPSB1c2VybmFtZTtcclxuICAgIHRoaXMuZW1haWwgPSBlbWFpbDtcclxuICAgIHRoaXMudXNlcmltYWdlID0gdXNlcmltYWdlO1xyXG4gICAgdGhpcy5hZ2UgPSBhZ2U7XHJcbiAgICB0aGlzLmxhdCA9IGxhdDtcclxuICAgIHRoaXMubG5nID0gbG5nO1xyXG4gICAgdGhpcy5hZGRyZXNzID0gYWRkcmVzcztcclxuICAgIHRoaXMuY2hhdCA9IGNoYXQ7XHJcbiAgICB0aGlzLmFkbWluID0gYWRtaW47XHJcbn1cclxuXHJcbkdmVXNlci5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICByZXR1cm4gdGhpcy51c2VybmFtZTtcclxufTtcclxuIiwiZnVuY3Rpb24gU2VhcmNoUmVzdWx0KHRpdGxlLCBzdWJ0aXRsZSwgaWQsIHJlc3VsdFNvcnQpIHtcclxuICAgIHRoaXMudGl0bGUgPSB0aXRsZTtcclxuICAgIHRoaXMuc3VidGl0bGUgPSBzdWJ0aXRsZTtcclxuICAgIHRoaXMuaWQgPSBpZDtcclxuICAgIHRoaXMucmVzdWx0U29ydCA9IHJlc3VsdFNvcnQ7XHJcbn1cclxuU2VhcmNoUmVzdWx0LnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uICgpIHtcclxuICAgIHJldHVybiB0aGlzLnRpdGxlO1xyXG59O1xyXG4iLCIvKipcclxuICogQ3JlYXRlZCBieSBKb25hdGFuIG9uIDMxLzEyLzIwMTUuXHJcbiAqL1xyXG5cclxuZnVuY3Rpb24gRXZlbnRTZXJ2aWNlRXhjZXB0aW9uKG1lc3NhZ2UpIHtcclxuICAgIHRoaXMubmFtZSA9IFwiRXZlbnRTZXJ2aWNlRXhjZXB0aW9uXCI7XHJcbiAgICB0aGlzLm1lc3NhZ2UgPSBtZXNzYWdlO1xyXG4gICAgdGhpcy5zdGFjayA9IChuZXcgRXJyb3IoKSkuc3RhY2s7XHJcbn1cclxuXHJcbi8vIElFOVxyXG5cclxuRXZlbnRTZXJ2aWNlRXhjZXB0aW9uLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoRXJyb3IucHJvdG90eXBlKTtcclxuRXZlbnRTZXJ2aWNlRXhjZXB0aW9uLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IEV2ZW50U2VydmljZUV4Y2VwdGlvbjsiLCIvKipcclxuICogQ3JlYXRlZCBieSBKb25hdGFuIG9uIDMxLzEyLzIwMTUuXHJcbiAqL1xyXG5cclxuZnVuY3Rpb24gUHJvZmlsZVNlcnZpY2VFeGNlcHRpb24obWVzc2FnZSkge1xyXG4gICAgdGhpcy5uYW1lID0gXCJQcm9maWxlU2VydmljZUV4Y2VwdGlvblwiO1xyXG4gICAgdGhpcy5tZXNzYWdlID0gbWVzc2FnZTtcclxuICAgIHRoaXMuc3RhY2sgPSAobmV3IEVycm9yKCkpLnN0YWNrO1xyXG59XHJcblxyXG4vLyBJRTlcclxuXHJcblByb2ZpbGVTZXJ2aWNlRXhjZXB0aW9uLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoRXJyb3IucHJvdG90eXBlKTtcclxuUHJvZmlsZVNlcnZpY2VFeGNlcHRpb24ucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUHJvZmlsZVNlcnZpY2VFeGNlcHRpb247IiwiLyoqXHJcbiAqIENyZWF0ZWQgYnkgSm9uYXRhbiBvbiAzMS8xMi8yMDE1LlxyXG4gKi9cclxuXHJcbmZ1bmN0aW9uIFNoYXJlU2VydmljZUV4Y2VwdGlvbihtZXNzYWdlKSB7XHJcbiAgICB0aGlzLm5hbWUgPSBcIlNoYXJlU2VydmljZUV4Y2VwdGlvblwiO1xyXG4gICAgdGhpcy5tZXNzYWdlID0gbWVzc2FnZTtcclxuICAgIHRoaXMuc3RhY2sgPSAobmV3IEVycm9yKCkpLnN0YWNrO1xyXG59XHJcblxyXG4vLyBJRTlcclxuXHJcblNoYXJlU2VydmljZUV4Y2VwdGlvbi5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKEVycm9yLnByb3RvdHlwZSk7XHJcblNoYXJlU2VydmljZUV4Y2VwdGlvbi5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBTaGFyZVNlcnZpY2VFeGNlcHRpb247Il0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
